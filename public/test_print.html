<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ—ãƒªãƒ³ã‚¿ãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆ</title>
    <script src="js/StarWebPrintBuilder.js"></script>
    <script src="js/StarWebPrintTrader.js"></script>
</head>
<body style="padding: 20px; font-family: sans-serif;">

    <h2>ğŸ–¨ï¸ ãƒ—ãƒªãƒ³ã‚¿ãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
    
    <p>
        è¨­å®šã—ãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹: 
        <input type="text" id="ipAddress" value="192.168.1.200" style="padding:5px; font-size:1.2em; width: 150px;">
    </p>

    <button onclick="testPrint()" style="padding: 15px 30px; font-size: 1.2em; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
        ãƒ†ã‚¹ãƒˆå°åˆ·ã‚’å®Ÿè¡Œã™ã‚‹
    </button>

    <div id="status" style="margin-top: 20px; padding: 10px; background: #f0f0f0;">
        ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™...
    </div>

    <script>
        function testPrint() {
            const ip = document.getElementById('ipAddress').value;
            const url = `http://${ip}/StarWebPRNT/SendMessage`;
            const statusDiv = document.getElementById('status');

            statusDiv.innerHTML = 'ğŸ”„ é€ä¿¡ä¸­... (' + url + ')';

            try {
                // 1. å°åˆ·ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
                const builder = new StarWebPrintBuilder();
                let request = '';

                request += builder.createInitializationElement();
                request += builder.createAlignmentElement({ alignment: 'center' });
                request += builder.createTextElement({ data: 'CONNECTION TEST\n', emphasis: true, width: 2, height: 2 });
                request += builder.createTextElement({ data: '----------------\n' });
                request += builder.createTextElement({ data: 'æ¥ç¶šæˆåŠŸï¼\n' });
                request += builder.createTextElement({ data: 'æ¾ä¹ƒæœ¨é£¯åº— ã‚·ã‚¹ãƒ†ãƒ \n\n\n' });
                request += builder.createCutPaperElement({ type: 'partial' });

                // 2. ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã¸é€ä¿¡
                const trader = new StarWebPrintTrader({ url: url });

                trader.onReceive = function (response) {
                    if (response.traderSuccess && response.traderStatus === '0') {
                        statusDiv.innerHTML = '<span style="color:green; font-weight:bold;">âœ… æˆåŠŸï¼å°åˆ·ã•ã‚Œã¾ã—ãŸã€‚</span>';
                        statusDiv.innerHTML += '<br>ã“ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ (' + ip + ') ã‚’æœ¬ç•ªã‚³ãƒ¼ãƒ‰ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                    } else {
                        statusDiv.innerHTML = '<span style="color:red;">âŒ å¤±æ•—: ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã¯åå¿œã—ã¾ã—ãŸãŒã‚¨ãƒ©ãƒ¼ã§ã™ã€‚</span>';
                        console.log(response);
                    }
                };

                trader.onError = function (response) {
                    statusDiv.innerHTML = '<span style="color:red;">âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼</span><br>PCã¨ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ãŒç¹‹ãŒã‚Šã¾ã›ã‚“ã€‚<br>ãƒ»IPã‚¢ãƒ‰ãƒ¬ã‚¹è¨­å®šã¯åˆã£ã¦ã„ã¾ã™ã‹ï¼Ÿ<br>ãƒ»åŒã˜Wi-Fiã«ç¹‹ãŒã£ã¦ã„ã¾ã™ã‹ï¼Ÿ';
                };

                trader.sendMessage({ request: request });

            } catch (e) {
                statusDiv.innerHTML = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + e.message;
            }
        }
    </script>
</body>
</html>