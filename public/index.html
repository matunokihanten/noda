<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¾ä¹ƒæœ¨é£¯åº— ãƒãƒƒãƒˆé †ç•ªå¾…ã¡</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; background: #fdfaf5; margin: 0; padding: 0; }
        header { background: #8b0000; color: white; padding: 15px; text-align: center; }
        .container { padding: 20px; max-width: 600px; margin: auto; }
        .box { background: white; padding: 20px; border-radius: 15px; border: 2px solid #d4b483; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.3s; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 1.1em; box-sizing: border-box; }
        .btn { background: #8b0000; color: white; border: none; padding: 15px; width: 100%; font-size: 1.2em; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .notice { background: #fff4f4; border: 3px solid #ff0000; padding: 15px; margin-top: 15px; text-align: center; border-radius: 10px; }
        .queue-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 20px; }
        .q-card { background: #fff; border: 1px solid #d4b483; padding: 10px; text-align: center; border-radius: 8px; }
        
        /* ğŸ“¢ å‘¼å‡ºæ™‚ã®ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes blink { 
            0% { opacity: 1; box-shadow: 0 0 20px rgba(231, 76, 60, 0.8); } 
            50% { opacity: 0.8; box-shadow: 0 0 5px rgba(231, 76, 60, 0.2); } 
            100% { opacity: 1; box-shadow: 0 0 20px rgba(231, 76, 60, 0.8); } 
        }
        .calling-box { 
            animation: blink 1.5s infinite; 
            background: #fff0f0; 
            border: 4px solid #e74c3c; 
        }
    </style>
</head>
<body>
    <header><h1>ğŸ® æ¾ä¹ƒæœ¨é£¯åº— ãƒãƒƒãƒˆå—ä»˜</h1></header>
    <div class="container">
        <div id="formArea" class="box">
            <label>ğŸ“ ãŠåå‰ (ä»»æ„)</label>
            <input type="text" id="name" placeholder="ãŠåå‰">
            <label>â° åˆ°ç€äºˆå®šæ™‚åˆ»</label>
            <input type="time" id="targetTime">
            <label>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å¤§äººäººæ•°</label>
            <input type="number" id="adults" value="2" min="1">
            <label>ğŸª‘ åº§å¸­ã®å¸Œæœ›</label>
            <select id="pref">
                <option>ã©ã“ã§ã‚‚</option>
                <option>ãƒ†ãƒ¼ãƒ–ãƒ«</option>
                <option>åº§æ•·</option>
            </select>
            <button class="btn" onclick="send()">é †ç•ªå¾…ã¡ã‚’ç”³ã—è¾¼ã‚€</button>
        </div>

        <div id="ticketArea" class="box" style="display:none;">
            <h2 id="ticketTitle" style="text-align:center; color:#27ae60;">å—ä»˜å®Œäº†</h2>
            <div id="myId" style="font-size:4.5em; font-weight:bold; text-align:center; color:#8b0000; margin: 10px 0;">--</div>
            
            <div id="ticketNotice" class="notice">
                <b style="color:red; font-size:1.2em;">âš ï¸ ã”æ¥åº—æ™‚ã®ãŠé¡˜ã„</b><br>
                åº—èˆ—ã«åˆ°ç€ã—ãŸã‚‰ã€å…¥ã‚Šå£ã®ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§<br><b>ã“ã®ç•ªå·ã‚’ã‚¿ãƒƒãƒ—</b>ã—ã¦ãã ã•ã„ã€‚
            </div>

            <button id="enableSoundBtn" class="btn" style="background:#f39c12; margin-top:20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);" onclick="enableSound()">
                ğŸ”” ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å‘¼å‡ºéŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            </button>
        </div>

        <h3 style="margin-top:30px; text-align:center;">ğŸ“‹ ç¾åœ¨ã®å¾…ã¡çŠ¶æ³</h3>
        <div id="queueList" class="queue-grid"></div>
    </div>

    <script>
        const socket = io();
        let myDisplayId = null;
        let soundEnabled = false;

        // ã‚¹ãƒãƒ›ã®éŸ³å£°åˆ¶é™ã‚’è§£é™¤ã™ã‚‹
        function enableSound() {
            soundEnabled = true;
            document.getElementById('enableSoundBtn').style.display = 'none';
            document.getElementById('ticketTitle').innerText = 'âœ… éŸ³å£°é€šçŸ¥ ONï¼ˆå¾…æ©Ÿä¸­...ï¼‰';
            
            // ç„¡éŸ³ã®ãƒ€ãƒŸãƒ¼éŸ³å£°ã‚’å†ç”Ÿã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ã€ŒéŸ³ã‚’é³´ã‚‰ã™è¨±å¯ã€ã‚’ã‚‚ã‚‰ã†
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.connect(ctx.destination);
            osc.start();
            osc.stop();
        }

        // äºˆç´„é€ä¿¡
        function send() {
            const data = { 
                type: 'web', 
                name: document.getElementById('name').value,
                targetTime: document.getElementById('targetTime').value || 'ä»Šã™ã',
                adults: document.getElementById('adults').value,
                pref: document.getElementById('pref').value || 'ã©ã“ã§ã‚‚'
            };
            socket.emit('register', data);
        }

        // ç™»éŒ²å®Œäº†
        socket.on('registered', g => {
            myDisplayId = g.displayId;
            document.getElementById('formArea').style.display = 'none';
            document.getElementById('ticketArea').style.display = 'block';
            document.getElementById('myId').innerText = g.displayId;
        });

        // å…¨ä½“ã®ãƒªã‚¹ãƒˆæ›´æ–°
        socket.on('update', d => {
            document.getElementById('queueList').innerHTML = d.queue.map(g => `
                <div class="q-card" style="${g.called ? 'background:#fff0f0; border-color:#e74c3c;' : ''}">
                    <b style="color:#8b0000; font-size:1.2em;">${g.displayId}</b><br>
                    <small>${g.targetTime}</small><br>
                    ${g.called ? '<span style="color:red; font-weight:bold; font-size:0.9em;">ğŸ“¢å‘¼å‡ºä¸­</span>' : ''}
                </div>
            `).join('');
            
            // ã‚¹ãƒãƒ›ãŒã‚¹ãƒªãƒ¼ãƒ—ã‹ã‚‰å¾©å¸°ã—ãŸæ™‚ãªã©ã«ã€è‡ªåˆ†ãŒå‘¼ã°ã‚Œã¦ã„ãŸã‚‰ç”»é¢ã‚’èµ¤ãã™ã‚‹
            const myGuest = d.queue.find(g => g.displayId === myDisplayId);
            if (myGuest && myGuest.called) {
                showCalledScreen(myGuest);
            }
        });

        // ğŸ“¢ ç®¡ç†ç”»é¢ã‹ã‚‰ã€Œå‘¼å‡ºã€ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
        socket.on('called', g => {
            if (g.displayId === myDisplayId) {
                showCalledScreen(g);
                playCallSound(g);
            }
        });

        // ç”»é¢ã‚’ã€Œå‘¼å‡ºä¸­ã€ã®èµ¤ã„ç‚¹æ»…ã«å¤‰æ›´
        function showCalledScreen(g) {
            const ticketArea = document.getElementById('ticketArea');
            ticketArea.className = 'box calling-box'; // èµ¤ãç‚¹æ»…ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            
            document.getElementById('ticketTitle').innerText = 'ğŸ“¢ ãŠå‘¼ã³å‡ºã—ä¸­';
            document.getElementById('ticketTitle').style.color = '#e74c3c';
            document.getElementById('ticketTitle').style.fontSize = '2.2em';
            
            document.getElementById('ticketNotice').innerHTML = `
                <b style="color:red; font-size:1.6em;">ãŠå®¢æ§˜ã®é †ç•ªã«ãªã‚Šã¾ã—ãŸï¼</b><br><br>
                <span style="font-size:1.2em; font-weight:bold;">åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã«ãŠå£°ãŒã‘ãã ã•ã„ã€‚</span>
            `;
            document.getElementById('enableSoundBtn').style.display = 'none';
        }

        // ãƒãƒ£ã‚¤ãƒ ã¨éŸ³å£°ã®å†ç”Ÿ
        function playCallSound(g) {
            if (!soundEnabled) return;
            
            // 1. ã¾ãšã€Œãƒ”ãƒ­ãƒªãƒ­ãƒ³â™ªã€ã¨ã„ã†ãƒãƒ£ã‚¤ãƒ ã‚’é³´ã‚‰ã™
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioContext.currentTime); // ãƒ©
            osc.frequency.setValueAtTime(1108.73, audioContext.currentTime + 0.2); // ãƒ‰#
            osc.frequency.setValueAtTime(1318.51, audioContext.currentTime + 0.4); // ãƒŸ
            
            gain.gain.setValueAtTime(0, audioContext.currentTime);
            gain.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.5);
            
            osc.start(audioContext.currentTime);
            osc.stop(audioContext.currentTime + 1.5);

            // 2. ãƒãƒ£ã‚¤ãƒ ã®ç›´å¾Œã«ã€Œã€‡ç•ªã®ãŠå®¢æ§˜ã€œã€ã¨éŸ³å£°èª­ã¿ä¸Šã’
            setTimeout(() => {
                if (window.speechSynthesis) {
                    const text = `${g.displayId.replace('-', 'ç•ª')}ã®ãŠå®¢æ§˜ã€ãŠå¾…ãŸã›ã„ãŸã—ã¾ã—ãŸã€‚é †ç•ªã«ãªã‚Šã¾ã—ãŸã®ã§ã€ã‚¹ã‚¿ãƒƒãƒ•ã«ãŠå£°ãŒã‘ãã ã•ã„ã€‚`;
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ja-JP';
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                }
            }, 1200);
        }
    </script>
</body>
</html>
