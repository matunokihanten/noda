<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¾ä¹ƒæœ¨é£¯åº— ãƒãƒƒãƒˆé †ç•ªå¾…ã¡</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif; background: #fdfaf5; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: linear-gradient(135deg, #8b0000 0%, #b91d1d 100%); color: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        header h1 { margin: 0; font-size: 1.5em; font-weight: bold; }
        header .subtitle { font-size: 0.9em; opacity: 0.9; margin-top: 5px; }
        
        .main-container { display: flex; flex: 1; height: calc(100vh - 80px); }

        /* å·¦å´ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        .left-panel { width: 420px; padding: 20px; border-right: 2px solid #d4b483; display: flex; flex-direction: column; align-items: center; box-sizing: border-box; overflow-y: auto; background: linear-gradient(180deg, #fdfaf5 0%, #fff8f0 100%); }
        .form-box { background: white; padding: 20px; border-radius: 20px; width: 100%; border: 2px solid #d4b483; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* äººæ•°å…¥åŠ›ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .number-control { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f5f5f5; }
        .control-label { font-size: 0.95em; font-weight: bold; color: #333; margin-bottom: 8px; display: block; }
        .control-row { display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 10px; }
        .num-display { font-size: 2.2em; font-weight: bold; min-width: 60px; text-align: center; color: #8b0000; }
        .btn-step { background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); border: 2px solid #ccc; width: 50px; height: 50px; border-radius: 50%; font-size: 1.8em; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .btn-step:hover { background: linear-gradient(135deg, #e0e0e0 0%, #d0d0d0 100%); transform: scale(1.05); }
        .btn-step:active { transform: scale(0.95); }
        .quick-nums { display: flex; gap: 8px; margin-top: 10px; justify-content: center; }
        .btn-quick { background: #fff; border: 2px solid #d4b483; padding: 8px 15px; border-radius: 8px; font-size: 0.95em; cursor: pointer; transition: all 0.3s; font-weight: 600; }
        .btn-quick:hover { background: #d4b483; color: white; transform: translateY(-2px); }

        select { padding: 15px; margin: 15px 0; width: 100%; font-size: 1.15em; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer; transition: border-color 0.3s; }
        select:focus { outline: none; border-color: #8b0000; }
        
        .btn-submit { background: linear-gradient(135deg, #8b0000 0%, #b91d1d 100%); color: white; border: none; padding: 20px; width: 100%; font-size: 1.3em; border-radius: 12px; cursor: pointer; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 10px rgba(139, 0, 0, 0.3); }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(139, 0, 0, 0.4); }
        .btn-submit:active { transform: translateY(0); }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* å³å´ï¼šå¾…ã¡çŠ¶æ³ã‚°ãƒªãƒƒãƒ‰ */
        .right-panel { flex: 1; padding: 20px; background: white; overflow-y: auto; }
        .queue-header { text-align: center; margin-bottom: 15px; }
        .queue-header h2 { color: #8b0000; font-size: 1.6em; margin-bottom: 5px; }
        .queue-count { font-size: 1.2em; color: #666; }
        .queue-count .num { font-weight: bold; color: #8b0000; font-size: 1.4em; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .queue-card { background: linear-gradient(135deg, #fffcf5 0%, #fff8f0 100%); border: 2px solid #d4b483; border-radius: 12px; padding: 15px; text-align: center; transition: all 0.3s; }
        .queue-card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .queue-card.arrived { border-color: #27ae60; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); }
        .queue-card.called { border-color: #e67e22; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .queue-id { font-weight: bold; color: #8b0000; font-size: 1.4em; display: block; margin-bottom: 5px; }
        .queue-info { font-size: 0.85em; color: #666; line-height: 1.4; }
        .queue-status { font-size: 0.75em; font-weight: bold; margin-top: 5px; padding: 3px; border-radius: 3px; }

        /* å—ä»˜å®Œäº†ãƒã‚±ãƒƒãƒˆ */
        .ticket-area { border: 3px solid #8b0000; animation: fadeIn 0.5s; }
        .complete-id { font-size: 5em; color: #8b0000; font-weight: bold; text-align: center; margin: 20px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .success-message { color: #27ae60; font-size: 1.2em; font-weight: bold; margin: 10px 0; text-align: center; }
        .warning-box { background: linear-gradient(135deg, #fff3f3 0%, #ffe8e8 100%); padding: 15px; border-radius: 10px; font-size: 0.95em; color: #d35400; text-align: center; font-weight: bold; margin: 15px 0; border: 2px solid #ffd4d4; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* å‘¼ã³å‡ºã—é€šçŸ¥ */
        .call-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10000;
            text-align: center;
            display: none;
            animation: callPulse 1s infinite;
        }
        
        @keyframes callPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        
        .call-notification h2 { font-size: 3em; margin-bottom: 20px; }
        .call-notification p { font-size: 1.5em; }

        /* å—ä»˜åœæ­¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .stop-message { background: #fff3cd; border: 2px solid #ffc107; color: #856404; padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; }

        @media (max-width: 1000px) { 
            .main-container { flex-direction: column; }
            .left-panel { width: 100%; border-right: none; border-bottom: 2px solid #d4b483; }
            .grid-container { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ® æ¾ä¹ƒæœ¨é£¯åº—</h1>
        <div class="subtitle">ãƒãƒƒãƒˆé †ç•ªå¾…ã¡å—ä»˜</div>
    </header>
    
    <!-- å‘¼ã³å‡ºã—é€šçŸ¥ -->
    <div id="callNotification" class="call-notification">
        <h2>ğŸ“¢ ãŠå‘¼ã³å‡ºã—ã§ã™</h2>
        <p>ãŠå¸­ã®æº–å‚™ãŒã§ãã¾ã—ãŸ<br>åº—èˆ—ã¸ãŠè¶Šã—ãã ã•ã„</p>
    </div>
    
    <div class="main-container">
        <div class="left-panel">
            <div id="formArea" class="form-box">
                <h3 style="margin:0 0 20px; color:#8b0000; text-align:center; font-size:1.3em;">æ–°è¦å—ä»˜ãƒ•ã‚©ãƒ¼ãƒ </h3>
                
                <div id="stopMessage" class="stop-message" style="display:none;">
                    âš ï¸ ç¾åœ¨å—ä»˜ã‚’åœæ­¢ã—ã¦ã„ã¾ã™
                </div>
                
                <div class="number-control">
                    <label class="control-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å¤§äºº (ä¸­å­¦ç”Ÿä»¥ä¸Š)</label>
                    <div class="control-row">
                        <button class="btn-step" onclick="changeNum('adults', -1)">âˆ’</button>
                        <span id="display-adults" class="num-display">2</span>
                        <button class="btn-step" onclick="changeNum('adults', 1)">+</button>
                    </div>
                    <div class="quick-nums">
                        <button class="btn-quick" onclick="setNum('adults', 1)">1å</button>
                        <button class="btn-quick" onclick="setNum('adults', 2)">2å</button>
                        <button class="btn-quick" onclick="setNum('adults', 4)">4å</button>
                        <button class="btn-quick" onclick="setNum('adults', 6)">6å</button>
                    </div>
                </div>

                <div class="number-control">
                    <label class="control-label">ğŸ‘§ å­ä¾› (å°å­¦ç”Ÿ)</label>
                    <div class="control-row">
                        <button class="btn-step" onclick="changeNum('children', -1)">âˆ’</button>
                        <span id="display-children" class="num-display">0</span>
                        <button class="btn-step" onclick="changeNum('children', 1)">+</button>
                    </div>
                </div>

                <div class="number-control">
                    <label class="control-label">ğŸ‘¶ å¹¼å… (æœªå°±å­¦å…)</label>
                    <div class="control-row">
                        <button class="btn-step" onclick="changeNum('infants', -1)">âˆ’</button>
                        <span id="display-infants" class="num-display">0</span>
                        <button class="btn-step" onclick="changeNum('infants', 1)">+</button>
                    </div>
                </div>

                <label class="control-label">ğŸª‘ åº§å¸­ã®ã”å¸Œæœ›</label>
                <select id="pref">
                    <option>ã©ã“ã§ã‚‚</option>
                    <option>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</option>
                    <option>ãƒ†ãƒ¼ãƒ–ãƒ«</option>
                    <option>ãŠåº§æ•·</option>
                </select>
                
                <button id="regBtn" class="btn-submit" onclick="send()">âœ“ å—ä»˜ç¢ºå®š</button>
            </div>

            <div id="ticketArea" class="form-box ticket-area" style="display:none;">
                <p class="success-message">âœ… å—ä»˜å®Œäº†ã—ã¾ã—ãŸ</p>
                <div id="num" class="complete-id">--</div>
                <div class="warning-box">
                    ğŸ“¸ ã“ã®ç•ªå·ã‚’<br>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§<br>ä¿å­˜ã—ã¦ãã ã•ã„
                </div>
                <div style="text-align:center; color:#666; font-size:0.9em; margin:15px 0;">
                    é †ç•ªãŒè¿‘ã¥ãã¾ã—ãŸã‚‰<br>ãŠå‘¼ã³å‡ºã—ã„ãŸã—ã¾ã™<br><br>
                    <strong style="color:#8b0000;">åº—èˆ—åˆ°ç€æ™‚ã¯ã€åº—èˆ—ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§<br>ã“ã®ç•ªå·ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</strong>
                </div>
                <button class="btn-submit" onclick="closeTicket()" style="background:#666; margin-top:15px;">é–‰ã˜ã‚‹</button>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="queue-header">
                <h2>ğŸ“‹ ç¾åœ¨ã®å¾…ã¡çŠ¶æ³</h2>
                <div class="queue-count">
                    <span class="num" id="count">0</span> çµ„ã®ãŠå®¢æ§˜ãŒãŠå¾…ã¡ã§ã™
                </div>
            </div>
            <div id="queueList" class="grid-container"></div>
        </div>
    </div>

    <script>
        const socket = io();
        const type = new URLSearchParams(window.location.search).get('type') || 'web';
        
        let nums = { adults: 2, children: 0, infants: 0 };
        let isAccepting = true;
        let myNumber = null; // è‡ªåˆ†ã®å—ä»˜ç•ªå·

        function updateDisplays() {
            document.getElementById('display-adults').innerText = nums.adults;
            document.getElementById('display-children').innerText = nums.children;
            document.getElementById('display-infants').innerText = nums.infants;
        }

        function changeNum(key, step) {
            nums[key] = Math.max(0, nums[key] + step);
            if(key === 'adults' && nums.adults < 1) nums.adults = 1;
            updateDisplays();
        }

        function setNum(key, val) {
            nums[key] = val;
            updateDisplays();
        }

        socket.on('init', d => {
            isAccepting = d.isAccepting;
            updateAcceptanceUI();
            updateQueue(d);
        });

        socket.on('update', d => updateQueue(d));

        function updateQueue(d) {
            document.getElementById('count').innerText = d.queue.length;
            const list = document.getElementById('queueList');
            
            if (d.queue.length === 0) {
                list.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:40px; color:#999; font-size:1.1em;">ç¾åœ¨ãŠå¾…ã¡ã®ãŠå®¢æ§˜ã¯ã„ã¾ã›ã‚“</div>';
            } else {
                list.innerHTML = d.queue.map(g => {
                    let statusBadge = '';
                    let cardClass = '';
                    if (g.arrived) {
                        statusBadge = '<div class="queue-status" style="background:#27ae60;color:white;">âœ… åˆ°ç€æ¸ˆã¿</div>';
                        cardClass = 'arrived';
                    } else if (g.called) {
                        statusBadge = '<div class="queue-status" style="background:#e67e22;color:white;">ğŸ“¢ å‘¼ã³å‡ºã—ä¸­</div>';
                        cardClass = 'called';
                    }
                    
                    return `
                        <div class="queue-card ${cardClass}">
                            <span class="queue-id">${g.displayId}</span>
                            <div class="queue-info">
                                ğŸ‘¥ ${g.adults}å / ${g.children}å / ${g.infants}å<br>
                                ğŸª‘ ${g.pref}
                                ${statusBadge}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        socket.on('statusChange', s => { 
            isAccepting = s.isAccepting !== undefined ? s.isAccepting : s;
            updateAcceptanceUI();
        });

        // å‘¼ã³å‡ºã—é€šçŸ¥
        socket.on('guestCalled', data => {
            if (data.displayId === myNumber && data.type === 'web') {
                showCallNotification();
            }
        });

        socket.on('dailyReset', () => {
            alert('ğŸ”„ æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚ã‚·ã‚¹ãƒ†ãƒ ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚');
            myNumber = null;
            location.reload();
        });

        function showCallNotification() {
            const notification = document.getElementById('callNotification');
            notification.style.display = 'block';
            
            // éŸ³ã‚’é³´ã‚‰ã™ï¼ˆé€£ç¶š3å›ï¼‰
            playCallSound();
            setTimeout(playCallSound, 800);
            setTimeout(playCallSound, 1600);
            
            // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
            
            // 10ç§’å¾Œã«éè¡¨ç¤º
            setTimeout(() => {
                notification.style.display = 'none';
            }, 10000);
        }

        function playCallSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 880; // A5éŸ³
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function updateAcceptanceUI() {
            const btn = document.getElementById('regBtn');
            const msg = document.getElementById('stopMessage');
            
            btn.disabled = !isAccepting;
            btn.innerText = isAccepting ? "âœ“ å—ä»˜ç¢ºå®š" : "â¸ï¸ å—ä»˜åœæ­¢ä¸­";
            msg.style.display = isAccepting ? 'none' : 'block';
        }

        function send() {
            if (!isAccepting) {
                alert('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ç¾åœ¨å—ä»˜ã‚’åœæ­¢ã—ã¦ãŠã‚Šã¾ã™ã€‚');
                return;
            }
            socket.emit('register', { type, ...nums, pref: document.getElementById('pref').value });
        }

        function closeTicket() {
            document.getElementById('ticketArea').style.display='none';
            document.getElementById('formArea').style.display='block';
            nums = { adults: 2, children: 0, infants: 0 };
            updateDisplays();
        }

        socket.on('registered', g => {
            document.getElementById('formArea').style.display='none';
            document.getElementById('ticketArea').style.display='block';
            document.getElementById('num').innerText = g.displayId;
            myNumber = g.displayId; // è‡ªåˆ†ã®ç•ªå·ã‚’è¨˜æ†¶
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('myQueueNumber', g.displayId);
        });

        socket.on('error', err => {
            alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªåˆ†ã®ç•ªå·ã‚’å¾©å…ƒ
        window.addEventListener('load', () => {
            const savedNumber = localStorage.getItem('myQueueNumber');
            if (savedNumber) {
                myNumber = savedNumber;
            }
        });
    </script>
</body>
</html>
