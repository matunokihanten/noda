<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¾ä¹ƒæœ¨é£¯åº— ç®¡ç†ç”»é¢</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        .header { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; }
        .header h1 { color: #8b0000; font-size: 1.8em; margin-bottom: 10px; }
        .header .clock { font-size: 2em; font-weight: bold; color: #333; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); text-align: center; }
        .stat-value { font-size: 2.5em; font-weight: bold; color: #8b0000; }
        .stat-label { font-size: 0.9em; color: #666; margin-top: 5px; }
        
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .card h2 { color: #8b0000; margin-bottom: 15px; font-size: 1.4em; }
        
        button { cursor: pointer; padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; transition: all 0.3s; font-size: 1em; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-stop { background: #e74c3c; color: white; }
        .btn-start { background: #27ae60; color: white; }
        .btn-reset { background: #95a5a6; color: white; }
        .btn-complete { background: #2ecc71; color: white; padding: 8px 16px; font-size: 0.9em; }
        .btn-call { background: #e67e22; color: white; padding: 8px 16px; font-size: 0.9em; }
        .btn-absent { background: #e74c3c; color: white; padding: 8px 16px; font-size: 0.9em; }
        .btn-cancel-absent { background: #3498db; color: white; padding: 8px 16px; font-size: 0.9em; }
        
        #statusLabel { font-weight: bold; font-size: 1.2em; margin-bottom: 15px; padding: 10px; border-radius: 8px; text-align: center; }
        .status-accepting { background: #d4edda; color: #155724; }
        .status-stopped { background: #f8d7da; color: #721c24; }
        
        .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .controls label { font-weight: bold; margin-right: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        thead { background: #8b0000; color: white; }
        th { padding: 12px; text-align: center; font-weight: bold; }
        td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; }
        tbody tr:hover { background: #f8f9fa; }
        tbody tr.arrived { background: #d4edda; }
        tbody tr.called { background: #fff3cd; }
        tbody tr.absent { background: #f8d7da; opacity: 0.7; }
        .no-data { text-align: center; padding: 30px; color: #999; font-style: italic; }
        
        .wait-time { color: #e67e22; font-weight: bold; font-size: 0.9em; }
        .type-badge { padding: 4px 8px; border-radius: 5px; font-size: 0.85em; font-weight: bold; color: white; display: inline-block; }
        .type-web { background: #9b59b6; }
        .type-shop { background: #3498db; }
        .status-badge { padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin: 2px; display: inline-block; }
        .badge-arrived { background: #27ae60; color: white; }
        .badge-called { background: #e67e22; color: white; }
        .badge-absent { background: #e74c3c; color: white; }
        
        .action-buttons { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .controls { flex-direction: column; align-items: stretch; }
            .controls button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ® æ¾ä¹ƒæœ¨é£¯åº— ç®¡ç†ç”»é¢</h1>
        <div class="clock" id="clock">--:--:--</div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="queueCount">0</div>
            <div class="stat-label">ç¾åœ¨å¾…ã¡çµ„æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalToday">0</div>
            <div class="stat-label">æœ¬æ—¥å—ä»˜ç·æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="completedToday">0</div>
            <div class="stat-label">æœ¬æ—¥æ¡ˆå†…å®Œäº†</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="avgWait">0</div>
            <div class="stat-label">å¹³å‡å¾…ã¡æ™‚é–“(åˆ†)</div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ å—ä»˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>
        <div id="statusLabel" class="status-accepting">çŠ¶æ…‹ç¢ºèªä¸­...</div>
        <div class="controls">
            <label>åœæ­¢æ™‚é–“è¨­å®šï¼š</label>
            <button class="btn-stop" onclick="setAccept(false, 0)">ä»Šã™ãåœæ­¢</button>
            <button class="btn-stop" onclick="setAccept(false, 30)">30åˆ†åœæ­¢</button>
            <button class="btn-stop" onclick="setAccept(false, 60)">60åˆ†åœæ­¢</button>
            <button class="btn-start" onclick="setAccept(true, 0)">â–¶ å—ä»˜å†é–‹</button>
            <button class="btn-reset" onclick="resetStats()">ğŸ“Š çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ‘¥ å¾…ã¡çŠ¶æ³ä¸€è¦§</h2>
        <table>
            <thead>
                <tr>
                    <th>ç•ªå·</th>
                    <th>å—ä»˜æ™‚åˆ»</th>
                    <th>å¾…ã¡æ™‚é–“</th>
                    <th>äººæ•°(å¤§/å­/å¹¼)</th>
                    <th>åº§å¸­å¸Œæœ›</th>
                    <th>ã‚¿ã‚¤ãƒ—</th>
                    <th>çŠ¶æ…‹</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="list">
                <tr><td colspan="8" class="no-data">å¾…ã¡å®¢ã¯ã„ã¾ã›ã‚“</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const socket = io();
        
        // æ™‚è¨ˆæ›´æ–°
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('ja-JP', {
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // å¾…ã¡æ™‚é–“è¨ˆç®—
        function getWaitTime(timestamp) {
            const now = Date.now();
            const diff = Math.floor((now - timestamp) / 1000 / 60); // åˆ†å˜ä½
            if (diff < 60) return `${diff}åˆ†`;
            const hours = Math.floor(diff / 60);
            const mins = diff % 60;
            return `${hours}æ™‚é–“${mins}åˆ†`;
        }

        // UIæ›´æ–°
        function updateUI(d) {
            const stats = d.stats || {};
            document.getElementById('queueCount').innerText = d.queue.length;
            document.getElementById('totalToday').innerText = stats.totalToday || 0;
            document.getElementById('completedToday').innerText = stats.completedToday || 0;
            document.getElementById('avgWait').innerText = stats.averageWaitTime || 0;

            const list = document.getElementById('list');
            if (d.queue.length === 0) {
                list.innerHTML = '<tr><td colspan="8" class="no-data">å¾…ã¡å®¢ã¯ã„ã¾ã›ã‚“</td></tr>';
            } else {
                list.innerHTML = d.queue.map(g => {
                    const waitTime = getWaitTime(g.timestamp);
                    const typeLabel = g.type === 'shop' ? 'åº—èˆ—' : 'Web';
                    const typeClass = g.type === 'shop' ? 'type-shop' : 'type-web';
                    
                    let rowClass = '';
                    let statusBadges = '';
                    let actionButtons = '';
                    
                    if (g.arrived) {
                        rowClass = 'arrived';
                        statusBadges += '<span class="status-badge badge-arrived">âœ… åˆ°ç€æ¸ˆã¿</span>';
                    }
                    if (g.called) {
                        rowClass = 'called';
                        statusBadges += '<span class="status-badge badge-called">ğŸ“¢ å‘¼ã³å‡ºã—ä¸­</span>';
                    }
                    if (g.absent) {
                        rowClass = 'absent';
                        statusBadges += '<span class="status-badge badge-absent">âš ï¸ ä¸åœ¨(10åˆ†å¾Œè‡ªå‹•å‰Šé™¤)</span>';
                        actionButtons += `<button class="btn-cancel-absent" onclick="cancelAbsent('${g.displayId}')">ä¸åœ¨è§£é™¤</button>`;
                    } else {
                        actionButtons += `<button class="btn-absent" onclick="markAbsent('${g.displayId}')">ä¸åœ¨</button>`;
                    }
                    
                    if (!g.called) {
                        actionButtons += `<button class="btn-call" onclick="callGuest('${g.displayId}')">ğŸ“¢ å‘¼ã³å‡ºã—</button>`;
                    }
                    actionButtons += `<button class="btn-complete" onclick="done('${g.displayId}')">âœ“ æ¡ˆå†…å®Œäº†</button>`;
                    
                    return `
                        <tr class="${rowClass}">
                            <td style="font-weight:bold; color:#8b0000; font-size:1.1em;">${g.displayId}</td>
                            <td>${g.time}</td>
                            <td class="wait-time">${waitTime}</td>
                            <td>${g.adults}å / ${g.children}å / ${g.infants}å</td>
                            <td>${g.pref}</td>
                            <td><span class="type-badge ${typeClass}">${typeLabel}</span></td>
                            <td>${statusBadges || '-'}</td>
                            <td><div class="action-buttons">${actionButtons}</div></td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
        socket.on('statusChange', s => {
            const isAccepting = s.isAccepting !== undefined ? s.isAccepting : s;
            const label = document.getElementById('statusLabel');
            if (isAccepting) {
                label.innerText = "âœ… ç¾åœ¨ï¼šå—ä»˜ä¸­";
                label.className = "status-accepting";
            } else {
                label.innerText = "â¸ï¸ ç¾åœ¨ï¼šå—ä»˜åœæ­¢ä¸­";
                label.className = "status-stopped";
            }
        });

        socket.on('init', d => {
            updateUI(d);
            const label = document.getElementById('statusLabel');
            if (d.isAccepting) {
                label.innerText = "âœ… ç¾åœ¨ï¼šå—ä»˜ä¸­";
                label.className = "status-accepting";
            } else {
                label.innerText = "â¸ï¸ ç¾åœ¨ï¼šå—ä»˜åœæ­¢ä¸­";
                label.className = "status-stopped";
            }
        });
        
        socket.on('update', d => updateUI(d));

        socket.on('guestArrived', data => {
            // åˆ°ç€é€šçŸ¥ã®éŸ³ã‚’é³´ã‚‰ã™
            playSound('info');
        });

        socket.on('dailyReset', () => {
            alert('ğŸ”„ æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚æ–°ã—ã„1æ—¥ãŒå§‹ã¾ã‚Šã¾ã™ï¼');
            location.reload();
        });

        function done(id) { 
            if (confirm(`${id} ã‚’æ¡ˆå†…å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ`)) {
                socket.emit('updateStatus', { displayId: id, status: 'completed' }); 
            }
        }

        function callGuest(id) {
            if (confirm(`${id} ã®ãŠå®¢æ§˜ã‚’å‘¼ã³å‡ºã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç›¸æ‰‹ã®ã‚¹ãƒãƒ›ã«é€šçŸ¥ãŒå±Šãã¾ã™ï¼‰`)) {
                socket.emit('callGuest', { displayId: id });
                playSound('call');
            }
        }

        function markAbsent(id) {
            if (confirm(`${id} ã‚’ä¸åœ¨ã«ãƒãƒ¼ã‚¯ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆ10åˆ†å¾Œã«è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`)) {
                socket.emit('markAbsent', { displayId: id });
            }
        }

        function cancelAbsent(id) {
            if (confirm(`${id} ã®ä¸åœ¨ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                socket.emit('cancelAbsent', { displayId: id });
            }
        }
        
        function setAccept(status, duration) { 
            const msg = status 
                ? 'å—ä»˜ã‚’å†é–‹ã—ã¾ã™ã‹ï¼Ÿ' 
                : (duration > 0 ? `${duration}åˆ†é–“å—ä»˜ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ` : 'å—ä»˜ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ');
            if (confirm(msg)) {
                socket.emit('setAcceptance', { status, duration }); 
            }
        }

        function resetStats() {
            if (confirm('æœ¬æ—¥ã®çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå¾…ã¡çŠ¶æ³ã¯ä¿æŒã•ã‚Œã¾ã™ï¼‰')) {
                socket.emit('resetStats');
            }
        }

        // ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿ
        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'call') {
                oscillator.frequency.value = 880;
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'info') {
                oscillator.frequency.value = 600;
                gainNode.gain.value = 0.2;
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            }
        }

        // å®šæœŸçš„ã«å¾…ã¡æ™‚é–“ã‚’æ›´æ–°ï¼ˆ1åˆ†ã”ã¨ï¼‰
        setInterval(() => {
            const rows = document.querySelectorAll('#list tr');
            // å…¨ä½“ã‚’å†æç”»ã™ã‚‹ã®ã§ã¯ãªãã€å¿…è¦ã«å¿œã˜ã¦updateUIã‚’å‘¼ã¶
        }, 60000);
    </script>
</body>
</html>
