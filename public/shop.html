<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¾ä¹ƒæœ¨é£¯åº— åº—èˆ—å—ä»˜</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: linear-gradient(135deg, #8b0000 0%, #b91d1d 100%); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        header h1 { margin: 0; font-size: 2em; font-weight: bold; }
        header .subtitle { font-size: 1.1em; opacity: 0.9; margin-top: 5px; }
        
        .main-container { flex: 1; padding: 20px; overflow-y: auto; }
        
        .section { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .section h2 { color: #8b0000; margin-bottom: 15px; font-size: 1.5em; }
        
        .form-box { background: white; padding: 20px; border-radius: 20px; border: 2px solid #d4b483; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* äººæ•°å…¥åŠ›ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .number-control { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f5f5f5; }
        .control-label { font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 8px; display: block; }
        .control-row { display: flex; align-items: center; justify-content: center; gap: 20px; margin-top: 10px; }
        .num-display { font-size: 2.8em; font-weight: bold; min-width: 80px; text-align: center; color: #8b0000; }
        .btn-step { background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); border: 2px solid #ccc; width: 60px; height: 60px; border-radius: 50%; font-size: 2em; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .btn-step:hover { background: linear-gradient(135deg, #e0e0e0 0%, #d0d0d0 100%); transform: scale(1.1); }
        .btn-step:active { transform: scale(0.95); }
        .quick-nums { display: flex; gap: 10px; margin-top: 12px; justify-content: center; flex-wrap: wrap; }
        .btn-quick { background: #fff; border: 2px solid #d4b483; padding: 10px 20px; border-radius: 10px; font-size: 1.1em; cursor: pointer; transition: all 0.3s; font-weight: 600; }
        .btn-quick:hover { background: #d4b483; color: white; transform: translateY(-2px); }

        select { padding: 15px; margin: 15px 0; width: 100%; font-size: 1.3em; border: 2px solid #ddd; border-radius: 10px; background: white; cursor: pointer; }
        
        .btn-submit { background: linear-gradient(135deg, #8b0000 0%, #b91d1d 100%); color: white; border: none; padding: 25px; width: 100%; font-size: 1.5em; border-radius: 12px; cursor: pointer; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 10px rgba(139, 0, 0, 0.3); }
        .btn-submit:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(139, 0, 0, 0.4); }
        .btn-submit:active { transform: translateY(0); }

        /* å¾…ã¡çŠ¶æ³ã‚°ãƒªãƒƒãƒ‰ */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .queue-card { background: linear-gradient(135deg, #fffcf5 0%, #fff8f0 100%); border: 3px solid #d4b483; border-radius: 15px; padding: 20px; text-align: center; transition: all 0.3s; cursor: pointer; position: relative; }
        .queue-card:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .queue-card.arrived { border-color: #27ae60; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); }
        .queue-card.called { border-color: #e67e22; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); animation: pulse 2s infinite; }
        .queue-card.absent { border-color: #e74c3c; background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); opacity: 0.7; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .queue-id { font-weight: bold; color: #8b0000; font-size: 2em; display: block; margin-bottom: 8px; }
        .queue-info { font-size: 1em; color: #666; line-height: 1.6; }
        .queue-status { font-size: 0.9em; font-weight: bold; margin-top: 8px; padding: 5px; border-radius: 5px; }
        .status-arrived { background: #27ae60; color: white; }
        .status-called { background: #e67e22; color: white; }
        .status-absent { background: #e74c3c; color: white; }

        /* å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .complete-id { font-size: 5em; color: #8b0000; font-weight: bold; text-align: center; margin: 20px 0; }
        
        .stop-message { background: #fff3cd; border: 2px solid #ffc107; color: #856404; padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 1.1em; }
    </style>
</head>
<body>
    <header>
        <h1>ğŸª æ¾ä¹ƒæœ¨é£¯åº— åº—èˆ—å—ä»˜</h1>
        <div class="subtitle">ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨ç”»é¢</div>
    </header>
    
    <div class="main-container">
        <!-- æ–°è¦å—ä»˜ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="formArea" class="form-box">
            <h3 style="margin:0 0 20px; color:#8b0000; text-align:center; font-size:1.6em;">ğŸ‘¥ åº—èˆ—ã§ç›´æ¥å—ä»˜</h3>
            
            <div id="stopMessage" class="stop-message" style="display:none;">
                âš ï¸ ç¾åœ¨å—ä»˜ã‚’åœæ­¢ã—ã¦ã„ã¾ã™
            </div>
            
            <div class="number-control">
                <label class="control-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å¤§äºº (ä¸­å­¦ç”Ÿä»¥ä¸Š)</label>
                <div class="control-row">
                    <button class="btn-step" onclick="changeNum('adults', -1)">âˆ’</button>
                    <span id="display-adults" class="num-display">2</span>
                    <button class="btn-step" onclick="changeNum('adults', 1)">+</button>
                </div>
                <div class="quick-nums">
                    <button class="btn-quick" onclick="setNum('adults', 1)">1å</button>
                    <button class="btn-quick" onclick="setNum('adults', 2)">2å</button>
                    <button class="btn-quick" onclick="setNum('adults', 4)">4å</button>
                    <button class="btn-quick" onclick="setNum('adults', 6)">6å</button>
                </div>
            </div>

            <div class="number-control">
                <label class="control-label">ğŸ‘§ å­ä¾› (å°å­¦ç”Ÿ)</label>
                <div class="control-row">
                    <button class="btn-step" onclick="changeNum('children', -1)">âˆ’</button>
                    <span id="display-children" class="num-display">0</span>
                    <button class="btn-step" onclick="changeNum('children', 1)">+</button>
                </div>
            </div>

            <div class="number-control">
                <label class="control-label">ğŸ‘¶ å¹¼å… (æœªå°±å­¦å…)</label>
                <div class="control-row">
                    <button class="btn-step" onclick="changeNum('infants', -1)">âˆ’</button>
                    <span id="display-infants" class="num-display">0</span>
                    <button class="btn-step" onclick="changeNum('infants', 1)">+</button>
                </div>
            </div>

            <label class="control-label">ğŸª‘ åº§å¸­ã®ã”å¸Œæœ›</label>
            <select id="pref">
                <option>ã©ã“ã§ã‚‚</option>
                <option>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</option>
                <option>ãƒ†ãƒ¼ãƒ–ãƒ«</option>
                <option>ãŠåº§æ•·</option>
            </select>
            
            <button id="regBtn" class="btn-submit" onclick="send()">âœ“ å—ä»˜ç¢ºå®š</button>
        </div>

        <div id="ticketArea" class="form-box" style="display:none; border: 3px solid #8b0000;">
            <p style="color:#27ae60; font-size:1.5em; font-weight:bold; text-align:center; margin-bottom:15px;">âœ… å—ä»˜å®Œäº†ã—ã¾ã—ãŸ</p>
            <div id="num" class="complete-id">--</div>
            <button class="btn-submit" onclick="closeTicket()" style="background:#666; margin-top:15px;">é–‰ã˜ã‚‹</button>
        </div>

        <!-- å¾…ã¡çŠ¶æ³ï¼šåˆ°ç€ç¢ºèªç”¨ -->
        <div class="section">
            <h2>ğŸ“‹ ãƒãƒƒãƒˆäºˆç´„ã®æ–¹ - åˆ°ç€ç¢ºèª</h2>
            <p style="color:#666; margin-bottom:15px; font-size:1.1em;">â€» ãŠå®¢æ§˜ã«ç•ªå·ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„</p>
            <div id="queueListWeb" class="grid-container"></div>
        </div>

        <!-- å¾…ã¡çŠ¶æ³ï¼šåº—èˆ—å—ä»˜ -->
        <div class="section">
            <h2>ğŸ“‹ åº—èˆ—å—ä»˜ã®å¾…ã¡çŠ¶æ³</h2>
            <div id="queueListShop" class="grid-container"></div>
        </div>
    </div>

    <script>
        const socket = io();
        const type = 'shop'; // åº—èˆ—ã‚¿ã‚¤ãƒ—
        
        let nums = { adults: 2, children: 0, infants: 0 };
        let isAccepting = true;

        function updateDisplays() {
            document.getElementById('display-adults').innerText = nums.adults;
            document.getElementById('display-children').innerText = nums.children;
            document.getElementById('display-infants').innerText = nums.infants;
        }

        function changeNum(key, step) {
            nums[key] = Math.max(0, nums[key] + step);
            if(key === 'adults' && nums.adults < 1) nums.adults = 1;
            updateDisplays();
        }

        function setNum(key, val) {
            nums[key] = val;
            updateDisplays();
        }

        socket.on('init', d => {
            isAccepting = d.isAccepting;
            updateAcceptanceUI();
            updateQueue(d);
        });

        socket.on('update', d => updateQueue(d));

        function updateQueue(d) {
            const webQueue = d.queue.filter(g => g.type === 'web');
            const shopQueue = d.queue.filter(g => g.type === 'shop');
            
            const listWeb = document.getElementById('queueListWeb');
            const listShop = document.getElementById('queueListShop');
            
            // Webäºˆç´„ï¼ˆåˆ°ç€ç¢ºèªç”¨ï¼‰
            if (webQueue.length === 0) {
                listWeb.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:30px; color:#999; font-size:1.2em;">ãƒãƒƒãƒˆäºˆç´„ã®ãŠå®¢æ§˜ã¯ã„ã¾ã›ã‚“</div>';
            } else {
                listWeb.innerHTML = webQueue.map(g => {
                    let statusBadge = '';
                    let cardClass = '';
                    if (g.arrived) {
                        statusBadge = '<div class="queue-status status-arrived">âœ… åˆ°ç€æ¸ˆã¿</div>';
                        cardClass = 'arrived';
                    } else if (g.called) {
                        statusBadge = '<div class="queue-status status-called">ğŸ“¢ å‘¼ã³å‡ºã—ä¸­</div>';
                        cardClass = 'called';
                    } else if (g.absent) {
                        statusBadge = '<div class="queue-status status-absent">âš ï¸ ä¸åœ¨</div>';
                        cardClass = 'absent';
                    }
                    
                    return `
                        <div class="queue-card ${cardClass}" onclick="markArrived('${g.displayId}', ${g.arrived})">
                            <span class="queue-id">${g.displayId}</span>
                            <div class="queue-info">
                                ğŸ‘¥ ${g.adults}å / ${g.children}å / ${g.infants}å<br>
                                ğŸª‘ ${g.pref}<br>
                                ğŸ• ${g.time}
                            </div>
                            ${statusBadge}
                        </div>
                    `;
                }).join('');
            }
            
            // åº—èˆ—å—ä»˜
            if (shopQueue.length === 0) {
                listShop.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:30px; color:#999; font-size:1.2em;">åº—èˆ—å—ä»˜ã®ãŠå®¢æ§˜ã¯ã„ã¾ã›ã‚“</div>';
            } else {
                listShop.innerHTML = shopQueue.map(g => {
                    let statusBadge = '';
                    let cardClass = '';
                    if (g.called) {
                        statusBadge = '<div class="queue-status status-called">ğŸ“¢ å‘¼ã³å‡ºã—ä¸­</div>';
                        cardClass = 'called';
                    } else if (g.absent) {
                        statusBadge = '<div class="queue-status status-absent">âš ï¸ ä¸åœ¨</div>';
                        cardClass = 'absent';
                    }
                    
                    return `
                        <div class="queue-card ${cardClass}">
                            <span class="queue-id">${g.displayId}</span>
                            <div class="queue-info">
                                ğŸ‘¥ ${g.adults}å / ${g.children}å / ${g.infants}å<br>
                                ğŸª‘ ${g.pref}<br>
                                ğŸ• ${g.time}
                            </div>
                            ${statusBadge}
                        </div>
                    `;
                }).join('');
            }
        }

        // åˆ°ç€ãƒãƒ¼ã‚¯
        function markArrived(displayId, alreadyArrived) {
            if (alreadyArrived) {
                alert('ã“ã®ãŠå®¢æ§˜ã¯æ—¢ã«åˆ°ç€æ¸ˆã¿ã§ã™');
                return;
            }
            if (confirm(`${displayId} ã®ãŠå®¢æ§˜ãŒåˆ°ç€ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ`)) {
                socket.emit('markArrived', { displayId });
            }
        }

        socket.on('statusChange', s => { 
            isAccepting = s.isAccepting !== undefined ? s.isAccepting : s;
            updateAcceptanceUI();
        });

        socket.on('guestArrived', data => {
            // åˆ°ç€éŸ³ã‚’é³´ã‚‰ã™
            playSound('arrival');
        });

        socket.on('dailyReset', () => {
            alert('ğŸ”„ æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚æ–°ã—ã„1æ—¥ãŒå§‹ã¾ã‚Šã¾ã™ï¼');
            location.reload();
        });

        function updateAcceptanceUI() {
            const btn = document.getElementById('regBtn');
            const msg = document.getElementById('stopMessage');
            
            btn.disabled = !isAccepting;
            btn.innerText = isAccepting ? "âœ“ å—ä»˜ç¢ºå®š" : "â¸ï¸ å—ä»˜åœæ­¢ä¸­";
            msg.style.display = isAccepting ? 'none' : 'block';
        }

        function send() {
            if (!isAccepting) {
                alert('ç¾åœ¨å—ä»˜ã‚’åœæ­¢ã—ã¦ãŠã‚Šã¾ã™ã€‚');
                return;
            }
            socket.emit('register', { type, ...nums, pref: document.getElementById('pref').value });
        }

        function closeTicket() {
            document.getElementById('ticketArea').style.display='none';
            document.getElementById('formArea').style.display='block';
            nums = { adults: 2, children: 0, infants: 0 };
            updateDisplays();
        }

        socket.on('registered', g => {
            if (g.type === 'shop') {
                document.getElementById('formArea').style.display='none';
                document.getElementById('ticketArea').style.display='block';
                document.getElementById('num').innerText = g.displayId;
            }
        });

        socket.on('error', err => {
            alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
        });

        // ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿ
        function playSound(type) {
            const audio = new Audio();
            if (type === 'arrival') {
                // åˆ°ç€éŸ³ï¼ˆå‘¨æ³¢æ•°ã§ç”Ÿæˆï¼‰
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                gainNode.gain.value = 0.3;
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            }
        }
    </script>
</body>
</html>
