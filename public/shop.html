<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¾ä¹ƒæœ¨é£¯åº— åº—èˆ—å—ä»˜</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); display: flex; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden; }
        header { background: linear-gradient(135deg, #8b0000 0%, #b91d1d 100%); color: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 10; }
        header h1 { margin: 0; font-size: 1.8em; font-weight: bold; }
        header .subtitle { font-size: 1em; opacity: 0.9; margin-top: 5px; }
        
        /* â˜…ä¿®æ­£: é«˜ã•ã‚’æ˜ç¤ºçš„ã«è¨ˆç®—ã—ã€ç¢ºå®Ÿã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒæ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸ */
        .main-container { display: flex; flex: 1; overflow: hidden; height: calc(100% - 80px); }
        
        /* â˜…ä¿®æ­£: ä¸‹éƒ¨ã«ä½™è£•ï¼ˆpadding-bottom: 50pxï¼‰ã‚’æŒãŸã›ã€ãƒœã‚¿ãƒ³ãŒåŸ‹ã‚‚ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã—ãŸ */
        .left-panel { width: 450px; padding: 15px 15px 50px 15px; background: white; border-right: 3px solid #8b0000; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .section { background: #f8f9fa; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .section h2 { color: #8b0000; margin-bottom: 12px; font-size: 1.3em; }
        
        .form-box { background: white; padding: 15px; border-radius: 15px; border: 2px solid #d4b483; }
        
        input[type="text"] { padding: 10px; margin: 8px 0; width: 100%; font-size: 1em; border: 2px solid #ddd; border-radius: 8px; }
        
        /* äººæ•°å…¥åŠ›ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰ */
        .number-control { margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .control-label { font-size: 0.9em; font-weight: bold; color: #333; margin-bottom: 5px; display: block; }
        .control-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 5px; }
        .num-display { font-size: 1.8em; font-weight: bold; min-width: 50px; text-align: center; color: #8b0000; }
        .btn-step { background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); border: 2px solid #ccc; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5em; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-step:hover { background: linear-gradient(135deg, #e0e0e0 0%, #d0d0d0 100%); transform: scale(1.05); }
        .quick-nums { display: flex; gap: 6px; margin-top: 6px; justify-content: center; flex-wrap: wrap; }
        .btn-quick { background: #fff; border: 2px solid #d4b483; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .btn-quick:hover { background: #d4b483; color: white; }

        /* åº§å¸­ãƒœã‚¿ãƒ³ */
        .seat-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin: 10px 0; }
        .btn-seat { background: #fff; border: 2px solid #d4b483; padding: 12px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.2s; font-weight: 600; text-align: center; }
        .btn-seat:hover { transform: translateY(-2px); }
        .btn-seat.selected { background: #8b0000; color: white; border-color: #8b0000; }
        
        /* ãƒœã‚¿ãƒ³ã‚’è¦‹ã¤ã‘ã‚„ã™ãå°‘ã—ç›®ç«‹ãŸã›ã¦ã„ã¾ã™ */
        .btn-submit { background: linear-gradient(135deg, #8b0000 0%, #b91d1d 100%); color: white; border: none; padding: 15px; width: 100%; font-size: 1.2em; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s; box-shadow: 0 3px 8px rgba(139, 0, 0, 0.3); margin-top: 10px; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 5px 12px rgba(139, 0, 0, 0.4); }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* å³å´ï¼šå¾…ã¡çŠ¶æ³ */
        .right-panel { flex: 1; padding: 15px; overflow-y: auto; background: rgba(255,255,255,0.95); }
        
        .queue-section { margin-bottom: 20px; }
        .queue-section h3 { color: #8b0000; font-size: 1.4em; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #8b0000; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
        .queue-card { background: linear-gradient(135deg, #fffcf5 0%, #fff8f0 100%); border: 3px solid #d4b483; border-radius: 12px; padding: 12px; text-align: center; transition: all 0.3s; cursor: pointer; position: relative; }
        .queue-card:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        .queue-card.arrived { border-color: #27ae60; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); }
        .queue-card.called { border-color: #e67e22; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); animation: pulse 2s infinite; }
        .queue-card.absent { border-color: #e74c3c; background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); opacity: 0.7; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        
        .queue-id { font-weight: bold; color: #8b0000; font-size: 1.6em; display: block; margin-bottom: 6px; }
        .queue-info { font-size: 0.9em; color: #666; line-height: 1.4; }
        .queue-status { font-size: 0.8em; font-weight: bold; margin-top: 6px; padding: 4px; border-radius: 4px; }
        .status-arrived { background: #27ae60; color: white; }
        .status-called { background: #e67e22; color: white; }
        .status-absent { background: #e74c3c; color: white; }

        .complete-id { font-size: 4em; color: #8b0000; font-weight: bold; text-align: center; margin: 15px 0; }
        .stop-message { background: #fff3cd; border: 2px solid #ffc107; color: #856404; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 0.95em; }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›ç”¨ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œè¿½åŠ  */
        @media (max-width: 800px) {
            .main-container { flex-direction: column; }
            .left-panel { width: 100%; border-right: none; border-bottom: 3px solid #8b0000; max-height: 50vh; }
            .right-panel { max-height: 50vh; }
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸª æ¾ä¹ƒæœ¨é£¯åº— åº—èˆ—å—ä»˜</h1>
        <div class="subtitle">ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨ç”»é¢</div>
    </header>
    
    <div class="main-container">
        <div class="left-panel">
            <div id="formArea" class="form-box">
                <h3 style="margin:0 0 12px; color:#8b0000; text-align:center; font-size:1.2em;">ğŸ‘¥ åº—èˆ—ã§ç›´æ¥å—ä»˜</h3>
                
                <div id="stopMessage" class="stop-message" style="display:none;">
                    âš ï¸ ç¾åœ¨å—ä»˜ã‚’åœæ­¢ã—ã¦ã„ã¾ã™
                </div>
                
                <label class="control-label">ğŸ“ ãŠåå‰ï¼ˆä»»æ„ï¼‰</label>
                <input type="text" id="nameInput" placeholder="ãŠåå‰ã‚’å…¥åŠ›ï¼ˆçœç•¥å¯ï¼‰" maxlength="20">
                
                <div class="number-control">
                    <label class="control-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å¤§äºº (ä¸­å­¦ç”Ÿä»¥ä¸Š)</label>
                    <div class="control-row">
                        <button class="btn-step" onclick="changeNum('adults', -1)">âˆ’</button>
                        <span id="display-adults" class="num-display">2</span>
                        <button class="btn-step" onclick="changeNum('adults', 1)">+</button>
                    </div>
                    <div class="quick-nums">
                        <button class="btn-quick" onclick="setNum('adults', 1)">1å</button>
                        <button class="btn-quick" onclick="setNum('adults', 2)">2å</button>
                        <button class="btn-quick" onclick="setNum('adults', 4)">4å</button>
                        <button class="btn-quick" onclick="setNum('adults', 6)">6å</button>
                    </div>
                </div>

                <div class="number-control">
                    <label class="control-label">ğŸ‘§ å­ä¾› (å°å­¦ç”Ÿ)</label>
                    <div class="control-row">
                        <button class="btn-step" onclick="changeNum('children', -1)">âˆ’</button>
                        <span id="display-children" class="num-display">0</span>
                        <button class="btn-step" onclick="changeNum('children', 1)">+</button>
                    </div>
                </div>

                <div class="number-control">
                    <label class="control-label">ğŸ‘¶ å¹¼å… (æœªå°±å­¦å…)</label>
                    <div class="control-row">
                        <button class="btn-step" onclick="changeNum('infants', -1)">âˆ’</button>
                        <span id="display-infants" class="num-display">0</span>
                        <button class="btn-step" onclick="changeNum('infants', 1)">+</button>
                    </div>
                </div>

                <label class="control-label">ğŸª‘ åº§å¸­ã®ã”å¸Œæœ›</label>
                <div class="seat-buttons">
                    <button class="btn-seat selected" onclick="selectSeat('ã©ã“ã§ã‚‚')">ã©ã“ã§ã‚‚</button>
                    <button class="btn-seat" onclick="selectSeat('ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼')">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</button>
                    <button class="btn-seat" onclick="selectSeat('ãƒ†ãƒ¼ãƒ–ãƒ«')">ãƒ†ãƒ¼ãƒ–ãƒ«</button>
                    <button class="btn-seat" onclick="selectSeat('ãŠåº§æ•·')">ãŠåº§æ•·</button>
                </div>
                
                <button id="regBtn" class="btn-submit" onclick="send()">âœ“ å—ä»˜ç¢ºå®šï¼ˆç™ºåˆ¸ã™ã‚‹ï¼‰</button>
            </div>

            <div id="ticketArea" class="form-box" style="display:none; border: 3px solid #8b0000;">
                <p style="color:#27ae60; font-size:1.2em; font-weight:bold; text-align:center; margin-bottom:10px;">âœ… å—ä»˜å®Œäº†ã—ã¾ã—ãŸ</p>
                <div id="num" class="complete-id">--</div>
                <button class="btn-submit" onclick="closeTicket()" style="background:#666;">æ¬¡ã®å—ä»˜ã¸</button>
            </div>
        </div>

        <div class="right-panel">
            <div class="queue-section">
                <h3>ğŸ“± ãƒãƒƒãƒˆäºˆç´„ã®æ–¹ - åˆ°ç€ç¢ºèª</h3>
                <p style="color:#666; margin-bottom:10px; font-size:0.95em;">â€» ãŠå®¢æ§˜ã«ç•ªå·ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„</p>
                <div id="queueListWeb" class="grid-container"></div>
            </div>

            <div class="queue-section">
                <h3>ğŸª åº—èˆ—å—ä»˜ã®å¾…ã¡çŠ¶æ³</h3>
                <div id="queueListShop" class="grid-container"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const type = 'shop';
        
        let nums = { adults: 2, children: 0, infants: 0 };
        let isAccepting = true;
        let selectedSeat = 'ã©ã“ã§ã‚‚';

        function updateDisplays() {
            document.getElementById('display-adults').innerText = nums.adults;
            document.getElementById('display-children').innerText = nums.children;
            document.getElementById('display-infants').innerText = nums.infants;
        }

        function changeNum(key, step) {
            nums[key] = Math.max(0, nums[key] + step);
            if(key === 'adults' && nums.adults < 1) nums.adults = 1;
            updateDisplays();
        }

        function setNum(key, val) {
            nums[key] = val;
            updateDisplays();
        }

        function selectSeat(seat) {
            selectedSeat = seat;
            document.querySelectorAll('.btn-seat').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent === seat) {
                    btn.classList.add('selected');
                }
            });
        }

        socket.on('init', d => {
            isAccepting = d.isAccepting;
            updateAcceptanceUI();
            updateQueue(d);
        });

        socket.on('update', d => updateQueue(d));

        function updateQueue(d) {
            const webQueue = d.queue.filter(g => g.type === 'web');
            const shopQueue = d.queue.filter(g => g.type === 'shop');
            
            const listWeb = document.getElementById('queueListWeb');
            const listShop = document.getElementById('queueListShop');
            
            // Webäºˆç´„ï¼ˆåˆ°ç€ç¢ºèªç”¨ï¼‰
            if (webQueue.length === 0) {
                listWeb.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:20px; color:#999; font-size:1em;">ãƒãƒƒãƒˆäºˆç´„ã®ãŠå®¢æ§˜ã¯ã„ã¾ã›ã‚“</div>';
            } else {
                listWeb.innerHTML = webQueue.map(g => {
                    let statusBadge = '';
                    let cardClass = '';
                    if (g.arrived) {
                        statusBadge = '<div class="queue-status status-arrived">âœ… åˆ°ç€æ¸ˆã¿</div>';
                        cardClass = 'arrived';
                    } else if (g.called) {
                        statusBadge = '<div class="queue-status status-called">ğŸ“¢ å‘¼ã³å‡ºã—ä¸­</div>';
                        cardClass = 'called';
                    } else if (g.absent) {
                        statusBadge = '<div class="queue-status status-absent">âš ï¸ ä¸åœ¨</div>';
                        cardClass = 'absent';
                    }
                    
                    const nameDisplay = g.name ? `<div style="font-size:0.85em;color:#8b0000;font-weight:bold;">${g.name}æ§˜</div>` : '';
                    
                    return `
                        <div class="queue-card ${cardClass}" onclick="markArrived('${g.displayId}', ${g.arrived})">
                            <span class="queue-id">${g.displayId}</span>
                            ${nameDisplay}
                            <div class="queue-info">
                                ğŸ‘¥ ${g.adults}å / ${g.children}å / ${g.infants}å<br>
                                ğŸª‘ ${g.pref}<br>
                                ğŸ• ${g.time}
                            </div>
                            ${statusBadge}
                        </div>
                    `;
                }).join('');
            }
            
            // åº—èˆ—å—ä»˜
            if (shopQueue.length === 0) {
                listShop.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:20px; color:#999; font-size:1em;">åº—èˆ—å—ä»˜ã®ãŠå®¢æ§˜ã¯ã„ã¾ã›ã‚“</div>';
            } else {
                listShop.innerHTML = shopQueue.map(g => {
                    let statusBadge = '';
                    let cardClass = '';
                    if (g.called) {
                        statusBadge = '<div class="queue-status status-called">ğŸ“¢ å‘¼ã³å‡ºã—ä¸­</div>';
                        cardClass = 'called';
                    } else if (g.absent) {
                        statusBadge = '<div class="queue-status status-absent">âš ï¸ ä¸åœ¨</div>';
                        cardClass = 'absent';
                    }
                    
                    const nameDisplay = g.name ? `<div style="font-size:0.85em;color:#8b0000;font-weight:bold;">${g.name}æ§˜</div>` : '';
                    
                    return `
                        <div class="queue-card ${cardClass}">
                            <span class="queue-id">${g.displayId}</span>
                            ${nameDisplay}
                            <div class="queue-info">
                                ğŸ‘¥ ${g.adults}å / ${g.children}å / ${g.infants}å<br>
                                ğŸª‘ ${g.pref}<br>
                                ğŸ• ${g.time}
                            </div>
                            ${statusBadge}
                        </div>
                    `;
                }).join('');
            }
        }

        // åˆ°ç€ãƒãƒ¼ã‚¯
        function markArrived(displayId, alreadyArrived) {
            if (alreadyArrived) {
                alert('ã“ã®ãŠå®¢æ§˜ã¯æ—¢ã«åˆ°ç€æ¸ˆã¿ã§ã™');
                return;
            }
            if (confirm(`${displayId} ã®ãŠå®¢æ§˜ãŒåˆ°ç€ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ`)) {
                socket.emit('markArrived', { displayId });
            }
        }

        socket.on('statusChange', s => { 
            isAccepting = s.isAccepting !== undefined ? s.isAccepting : s;
            updateAcceptanceUI();
        });

        socket.on('guestArrived', data => {
            playSound('arrival');
        });

        // ç®¡ç†ç”»é¢ã‹ã‚‰å‘¼ã³å‡ºã—ãŒã‚ã£ãŸæ™‚ã«åº—èˆ—ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚‚éŸ³å£°ã‚’é³´ã‚‰ã™
        socket.on('guestCalled', data => {
            playSound('call');
            console.log('ğŸ“¢ å‘¼ã³å‡ºã—é€šçŸ¥:', data.displayId);
        });

        socket.on('dailyReset', () => {
            alert('ğŸ”„ æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚æ–°ã—ã„1æ—¥ãŒå§‹ã¾ã‚Šã¾ã™ï¼');
            location.reload();
        });

        function updateAcceptanceUI() {
            const btn = document.getElementById('regBtn');
            const msg = document.getElementById('stopMessage');
            
            btn.disabled = !isAccepting || nums.adults < 1;
            btn.innerText = isAccepting ? "âœ“ å—ä»˜ç¢ºå®šï¼ˆç™ºåˆ¸ã™ã‚‹ï¼‰" : "â¸ï¸ å—ä»˜åœæ­¢ä¸­";
            msg.style.display = isAccepting ? 'none' : 'block';
        }

        function send() {
            if (!isAccepting) {
                alert('ç¾åœ¨å—ä»˜ã‚’åœæ­¢ã—ã¦ãŠã‚Šã¾ã™ã€‚');
                return;
            }
            
            if (nums.adults < 1) {
                alert('å¤§äººã®äººæ•°ã¯1åä»¥ä¸Šå¿…è¦ã§ã™ã€‚');
                return;
            }
            
            const name = document.getElementById('nameInput').value.trim();
            const nameText = name ? `${name}æ§˜ ` : '';
            const confirmation = `${nameText}å¤§äºº${nums.adults}åã€å­ä¾›${nums.children}åã€å¹¼å…${nums.infants}åã€åº§å¸­ã€Œ${selectedSeat}ã€ã§å—ä»˜ã—ã¾ã™ã‹ï¼Ÿ`;
            
            if (confirm(confirmation)) {
                socket.emit('register', { type, ...nums, pref: selectedSeat, name });
            }
        }

        function closeTicket() {
            document.getElementById('ticketArea').style.display='none';
            document.getElementById('formArea').style.display='block';
            nums = { adults: 2, children: 0, infants: 0 };
            selectedSeat = 'ã©ã“ã§ã‚‚';
            document.getElementById('nameInput').value = '';
            updateDisplays();
            selectSeat('ã©ã“ã§ã‚‚');
        }

        socket.on('registered', g => {
            if (g.type === 'shop') {
                document.getElementById('formArea').style.display='none';
                document.getElementById('ticketArea').style.display='block';
                document.getElementById('num').innerText = g.displayId;
                
                // 3ç§’å¾Œã«è‡ªå‹•ã§æ¬¡ã®å—ä»˜ç”»é¢ã¸
                setTimeout(() => {
                    closeTicket();
                }, 3000);
            }
        });

        socket.on('error', err => {
            alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
        });

        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'call') {
                // å‘¼ã³å‡ºã—éŸ³ï¼ˆç®¡ç†ç”»é¢ã‹ã‚‰ã®å‘¼ã³å‡ºã—ï¼‰
                oscillator.frequency.value = 880;
                gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } else if (type === 'arrival') {
                // åˆ°ç€éŸ³
                oscillator.frequency.value = 800;
                gainNode.gain.value = 0.3;
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            }
        }
    </script>
</body>
</html>
