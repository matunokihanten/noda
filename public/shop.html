<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº—èˆ—å—ä»˜ & ç™ºåˆ¸ | æ¾ä¹ƒæœ¨é£¯åº—</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/StarWebPrintBuilder.js"></script>
    <script src="js/StarWebPrintTrader.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; background: #fdfaf5; }

        /* å·¦ãƒ‘ãƒãƒ«ï¼šå—ä»˜å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .left-panel { width: 40%; background: white; padding: 20px; border-right: 2px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 10; }
        
        h2 { color: #8b0000; border-bottom: 2px solid #8b0000; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5em; }
        
        .form-group { margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-bottom: 8px; color: #333; }
        
        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ è£…é£¾ */
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; font-size: 1.2em; border: 2px solid #ccc; border-radius: 8px; }
        input:focus { border-color: #8b0000; outline: none; }
        
        /* åº§å¸­ãƒœã‚¿ãƒ³ */
        .seat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .seat-btn { padding: 15px; border: 2px solid #ccc; background: #fff; border-radius: 8px; font-size: 1.1em; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .seat-btn.selected { background: #8b0000; color: white; border-color: #8b0000; }
        
        /* é€ä¿¡ãƒœã‚¿ãƒ³ */
        .submit-btn { background: #d35400; color: white; border: none; padding: 20px; width: 100%; font-size: 1.4em; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: auto; box-shadow: 0 4px 0 #a04000; }
        .submit-btn:active { transform: translateY(4px); box-shadow: none; }
        .submit-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        /* ãƒ—ãƒªãƒ³ã‚¿ãƒ¼è¨­å®šã‚¹ã‚¤ãƒƒãƒ */
        .printer-toggle { background: #e8f6f3; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #1abc9c; display: flex; align-items: center; justify-content: space-between; }
        .printer-status { font-weight: bold; color: #16a085; display: flex; align-items: center; gap: 5px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #1abc9c; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* å³ãƒ‘ãƒãƒ«ï¼šå¾…ã¡çŠ¶æ³ãƒªã‚¹ãƒˆ */
        .right-panel { width: 60%; background: #fdfaf5; padding: 20px; overflow-y: auto; }
        .queue-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        
        .guest-card { background: white; border: 2px solid #ddd; border-radius: 10px; padding: 15px; position: relative; transition: 0.3s; }
        .guest-card.arrived { border-color: #27ae60; background: #eafaf1; }
        .guest-card.web-user { border-left: 5px solid #9b59b6; } /* Webäºˆç´„ã¯ç´« */
        .guest-card.shop-user { border-left: 5px solid #3498db; } /* åº—èˆ—å—ä»˜ã¯é’ */
        
        .card-id { font-size: 1.8em; font-weight: bold; color: #333; margin-bottom: 5px; }
        .card-meta { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        .arrival-btn { width: 100%; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .arrival-btn.done { background: #7f8c8d; cursor: default; }
        
        .header-stats { display: flex; justify-content: space-between; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    </style>
</head>
<body>
    <div class="left-panel">
        <h2>ğŸ“  åº—èˆ—å—ä»˜ & ç™ºåˆ¸</h2>
        
        <div class="printer-toggle">
            <div class="printer-status">
                <span>ğŸ–¨ï¸ ãƒ¬ã‚·ãƒ¼ãƒˆè‡ªå‹•ç™ºåˆ¸</span>
            </div>
            <label class="switch">
                <input type="checkbox" id="autoPrint" checked>
                <span class="slider"></span>
            </label>
        </div>

        <div class="form-group">
            <label>äººæ•° (å¤§äºº)</label>
            <input type="number" id="adults" value="2" min="1">
        </div>
        <div class="form-group" style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>å­ä¾›</label>
                <input type="number" id="children" value="0" min="0">
            </div>
            <div style="flex:1;">
                <label>å¹¼å…</label>
                <input type="number" id="infants" value="0" min="0">
            </div>
        </div>

        <div class="form-group">
            <label>ãŠåå‰ (ä»»æ„)</label>
            <input type="text" id="name" placeholder="ãŠåå‰">
        </div>

        <div class="form-group">
            <label>åº§å¸­å¸Œæœ›</label>
            <div class="seat-grid">
                <button class="seat-btn selected" onclick="selectSeat('ã©ã“ã§ã‚‚')">ã©ã“ã§ã‚‚</button>
                <button class="seat-btn" onclick="selectSeat('ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼')">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</button>
                <button class="seat-btn" onclick="selectSeat('ãƒ†ãƒ¼ãƒ–ãƒ«')">ãƒ†ãƒ¼ãƒ–ãƒ«</button>
                <button class="seat-btn" onclick="selectSeat('ãŠåº§æ•·')">ãŠåº§æ•·</button>
            </div>
        </div>

        <button class="submit-btn" onclick="register()">ç™ºåˆ¸ã—ã¦å—ä»˜å®Œäº†</button>
    </div>

    <div class="right-panel">
        <div class="header-stats">
            <div>å¾…ã¡çµ„æ•°: <strong id="waitCount" style="font-size:1.5em; color:#d35400;">0</strong> çµ„</div>
            <div id="statusText">å—ä»˜ä¸­</div>
        </div>
        <h3 style="margin-bottom:15px; color:#666;">Webäºˆç´„ãƒ»åº—èˆ—å—ä»˜ä¸€è¦§</h3>
        <div id="queueList" class="queue-list">
            </div>
    </div>

    <script>
        const socket = io();
        
        // â˜… ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ (èª¿æŸ»ã—ãŸIPã‚’è¨­å®š)
        const PRINTER_IP = '192.168.1.190';
        const PRINTER_URL = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;

        let selectedSeat = 'ã©ã“ã§ã‚‚';
        let myLastRegisterId = null; // è‡ªåˆ†ãŒæœ€å¾Œã«ç™»éŒ²ã—ãŸIDï¼ˆé‡è¤‡å°åˆ·é˜²æ­¢ç”¨ï¼‰

        // åº§å¸­é¸æŠãƒ­ã‚¸ãƒƒã‚¯
        function selectSeat(seat) {
            selectedSeat = seat;
            document.querySelectorAll('.seat-btn').forEach(btn => {
                btn.classList.remove('selected');
                if(btn.innerText === seat) btn.classList.add('selected');
            });
        }

        // ç™»éŒ²é€ä¿¡
        function register() {
            const adults = document.getElementById('adults').value;
            const children = document.getElementById('children').value;
            const infants = document.getElementById('infants').value;
            const name = document.getElementById('name').value;

            if (adults < 1) { alert('å¤§äºº1åä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            
            // ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡ (type: 'shop' ã§é€ä¿¡)
            socket.emit('register', {
                type: 'shop',
                adults: Number(adults),
                children: Number(children),
                infants: Number(infants),
                pref: selectedSeat,
                name: name
            });
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            resetForm();
        }

        function resetForm() {
            document.getElementById('name').value = '';
            document.getElementById('adults').value = 2;
            document.getElementById('children').value = 0;
            document.getElementById('infants').value = 0;
            selectSeat('ã©ã“ã§ã‚‚');
        }

        // ==========================================
        // â˜… ã‚¹ã‚¿ãƒ¼ç²¾å¯† mC-Print3 å°åˆ·ãƒ­ã‚¸ãƒƒã‚¯
        // ==========================================
        function printReceipt(g) {
            try {
                // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã®ã‚¬ãƒ¼ãƒ‰
                if (typeof StarWebPrintBuilder === 'undefined') {
                    alert('å°åˆ·ã‚¨ãƒ©ãƒ¼: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚public/jsãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const builder = new StarWebPrintBuilder();
                let request = '';

                request += builder.createInitializationElement();

                // --- ãƒ¬ã‚·ãƒ¼ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³ä½œæˆ ---
                // ä¸­å¤®æƒãˆãƒ»ãƒ˜ãƒƒãƒ€ãƒ¼
                request += builder.createAlignmentElement({ alignment: 'center' });
                request += builder.createTextElement({ data: 'ğŸ® æ¾ä¹ƒæœ¨é£¯åº—\n', emphasis: true, width: 1 });
                request += builder.createTextElement({ data: 'å—ä»˜ç¥¨\n\n' });

                // å—ä»˜ç•ªå·ï¼ˆç‰¹å¤§ï¼‰
                request += builder.createTextElement({ data: 'ç•ªå·\n' });
                request += builder.createTextElement({ data: g.displayId + '\n', width: 2, height: 2, emphasis: true });
                request += builder.createTextElement({ data: '\n' });

                // è©³ç´°æƒ…å ±ï¼ˆå·¦æƒãˆï¼‰
                request += builder.createAlignmentElement({ alignment: 'left' });
                request += builder.createTextElement({ data: '--------------------------------\n' });
                request += builder.createTextElement({ data: 'å—ä»˜æ—¥æ™‚: ' + g.time + '\n' });
                if(g.name) {
                    request += builder.createTextElement({ data: 'ãŠåå‰ã€€: ' + g.name + ' æ§˜\n' });
                }
                request += builder.createTextElement({ data: 'äººæ•°ã€€ã€€: å¤§äºº' + g.adults + ' å­' + g.children + ' å¹¼' + g.infants + '\n' });
                request += builder.createTextElement({ data: 'åº§å¸­å¸Œæœ›: ' + g.pref + '\n' });
                request += builder.createTextElement({ data: '--------------------------------\n' });

                // ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆä¸­å¤®æƒãˆï¼‰
                request += builder.createAlignmentElement({ alignment: 'center' });
                request += builder.createTextElement({ data: '\nLINEã‚„Webã§é †ç•ªã‚’ç¢ºèªã§ãã¾ã™ã€‚\n' });
                request += builder.createTextElement({ data: 'ä¿‚å“¡ãŒãŠå‘¼ã³ã™ã‚‹ã¾ã§\nãŠå¾…ã¡ãã ã•ã„ã€‚\n\n' });

                // ç”¨ç´™ã‚«ãƒƒãƒˆ
                request += builder.createCutPaperElement({ type: 'full' });

                // --- ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã¸é€ä¿¡ ---
                const trader = new StarWebPrintTrader({ url: PRINTER_URL });
                
                trader.onReceive = function(response) {
                    if (response.traderSuccess && response.traderStatus === '0') {
                        console.log('å°åˆ·æˆåŠŸ');
                    } else {
                        console.error('å°åˆ·å¤±æ•—è©³ç´°:', response);
                    }
                };
                
                trader.onError = function(e) {
                    console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', e);
                    alert('ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚\nIPã‚¢ãƒ‰ãƒ¬ã‚¹: ' + PRINTER_IP + ' ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                };

                trader.sendMessage({ request: request });

            } catch (e) {
                console.error('å°åˆ·ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', e);
                alert('å°åˆ·å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        }

        // ==========================================
        // Socket.IO ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
        // ==========================================
        socket.on('registered', (guest) => {
            // è‡ªå‹•å°åˆ·ã‚¹ã‚¤ãƒƒãƒãŒON ã‹ã¤ åº—èˆ—å—ä»˜(shop)ã®å ´åˆã®ã¿å°åˆ·
            // â€» Webäºˆç´„ã‚‚å°åˆ·ã—ãŸã„å ´åˆã¯ g.type === 'web' ã®æ¡ä»¶ã‚’è¿½åŠ ã™ã‚‹
            const isAutoPrint = document.getElementById('autoPrint').checked;

            if (isAutoPrint && guest.type === 'shop') {
                // è‡ªåˆ†ãŒä»Šç™»éŒ²ã—ãŸã‚‚ã®ã‹ã€ã¾ãŸã¯åˆ¥ã®ç«¯æœ«ã§ç™»éŒ²ã•ã‚ŒãŸã‚‚ã®ã‹
                // ã“ã“ã§ã¯ã€Œåº—èˆ—å—ä»˜ã€ã•ã‚ŒãŸã‚‚ã®ã¯ã™ã¹ã¦ã“ã®ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã‹ã‚‰å°åˆ·ã™ã‚‹é‹ç”¨ã¨ã—ã¾ã™
                printReceipt(guest);
            }
            
            // è‡ªåˆ†ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã ã£ãŸå ´åˆã€é€šçŸ¥éŸ³
            if (myLastRegisterId === guest.displayId) {
                // å¿…è¦ãªã‚‰éŸ³ã‚’é³´ã‚‰ã™å‡¦ç†
            }
        });

        socket.on('init', updateUI);
        socket.on('update', updateUI);

        // åˆ°ç€é€šçŸ¥ã®å‡¦ç†ï¼ˆå³å´ãƒªã‚¹ãƒˆã®æ›´æ–°ï¼‰
        function updateUI(data) {
            const list = document.getElementById('queueList');
            document.getElementById('waitCount').innerText = data.queue.length;
            
            if(data.queue.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999; grid-column:1/-1;">å¾…ã¡å®¢ã¯ã„ã¾ã›ã‚“</p>';
                return;
            }

            list.innerHTML = data.queue.map(g => {
                const isArrived = g.arrived;
                const typeClass = g.type === 'web' ? 'web-user' : 'shop-user';
                const typeLabel = g.type === 'web' ? 'Webäºˆç´„' : 'åº—èˆ—å—ä»˜';
                
                let btnHtml = '';
                if (!isArrived && g.type === 'web') {
                    btnHtml = `<button class="arrival-btn" onclick="markArrived('${g.displayId}')">åˆ°ç€ç¢ºèª (ã‚¿ãƒƒãƒ—)</button>`;
                } else if (isArrived) {
                    btnHtml = `<button class="arrival-btn done">åˆ°ç€æ¸ˆã¿</button>`;
                } else {
                    btnHtml = `<div style="font-size:0.8em; color:#666; text-align:center;">åº—å†…ã§ãŠå¾…ã¡ã§ã™</div>`;
                }

                return `
                    <div class="guest-card ${isArrived ? 'arrived' : ''} ${typeClass}">
                        <div style="float:right; font-size:0.8em; font-weight:bold; color:#666;">${typeLabel}</div>
                        <div class="card-id">${g.displayId}</div>
                        <div class="card-meta">
                            ğŸ‘¤ å¤§äºº${g.adults}, å°${g.children}, å¹¼${g.infants}<br>
                            ğŸª‘ ${g.pref}<br>
                            ğŸ•’ ${g.time} å—ä»˜
                        </div>
                        ${btnHtml}
                    </div>
                `;
            }).join('');
        }

        function markArrived(id) {
            if(confirm('ã€Œ' + id + 'ã€ã®ãŠå®¢æ§˜ã‚’åˆ°ç€æ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ')) {
                socket.emit('markArrived', { displayId: id });
            }
        }
    </script>
</body>
</html>