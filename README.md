# 松乃木飯店 順番待ち受付システム

## プロジェクト概要

**松乃木飯店**の店舗向けリアルタイム順番待ち管理システムです。WebSocketを使用してリアルタイムに受付状況を同期し、店舗スタッフと来店客の双方にスムーズな待ち行列体験を提供します。

### 主な機能
- ✅ リアルタイム順番待ち受付
- 📊 管理画面での待ち状況管理と統計表示
- 📧 Web予約時の自動メール通知
- 💾 データ永続化（サーバー再起動時も復元）
- ⏸️ 受付の一時停止・自動再開
- 📱 レスポンシブデザイン対応

---

## 現在完成している機能

### ✅ 顧客向け受付画面 (`/`)
- 人数入力（大人・子供・幼児）
- 座席希望の選択（カウンター/テーブル/お座敷）
- リアルタイム待ち状況表示
- 受付番号の発行と表示
- 受付停止時の通知表示

### ✅ 管理画面 (`/admin`)
- リアルタイム時計表示
- 統計情報ダッシュボード
  - 現在待ち組数
  - 本日受付総数
  - 本日案内完了数
  - 平均待ち時間（分）
- 受付コントロール
  - 即時停止
  - 30分/60分停止（自動再開）
  - 手動再開
  - 統計リセット
- 待ち状況一覧
  - 受付番号
  - 受付時刻
  - 待ち時間（リアルタイム更新）
  - 人数詳細
  - 座席希望
  - 受付タイプ（店舗/Web）
  - 案内完了ボタン

### ✅ バックエンド機能
- Socket.IOによるリアルタイム通信
- JSONファイルによるデータ永続化
- Gmail SMTPによるメール通知
- エラーハンドリングとログ出力
- 環境変数対応

---

## 機能別URIとパラメータ

### エンドポイント一覧

| URI | 説明 | パラメータ |
|-----|------|-----------|
| `/` | 一般顧客向け受付画面 | `?type=web` (デフォルト) |
| `/` | 店舗側受付画面 | `?type=shop` |
| `/admin` | 管理画面 | なし |
| `/api/stats` | 統計情報API (GET) | なし |

### Socket.IOイベント

**クライアント → サーバー**
- `register` - 新規受付登録
- `updateStatus` - ステータス更新（案内完了）
- `setAcceptance` - 受付状態変更
- `resetStats` - 統計リセット

**サーバー → クライアント**
- `init` - 初期データ送信
- `update` - キューデータ更新
- `statusChange` - 受付状態変更通知
- `registered` - 登録完了通知
- `error` - エラー通知

---

## まだ実装されていない機能

以下の機能は基本システムには含まれていませんが、拡張可能です：

- ❌ ユーザー認証・ログイン機能（意図的に実装なし）
- ❌ SMS通知機能
- ❌ QRコード発行機能
- ❌ 多店舗対応
- ❌ 予約機能（現在は順番待ちのみ）
- ❌ データベース連携（現在はJSON保存）
- ❌ 分析・レポート機能
- ❌ モバイルアプリ

---

## 推奨される次の開発ステップ

1. **SMS通知の追加**
   - Twilio等のSMS APIを統合
   - 順番が近づいたら自動通知

2. **データベース移行**
   - SQLiteまたはPostgreSQLへの移行
   - より堅牢なデータ管理

3. **多言語対応**
   - 英語・中国語対応
   - 国際観光客向け

4. **QRコード機能**
   - 受付番号のQRコード生成
   - 読み取りによる本人確認

5. **分析ダッシュボード**
   - 週次・月次レポート
   - ピーク時間帯分析

---

## プロジェクト構造

```
webapp/
├── app.js                  # メインサーバーファイル
├── package.json            # 依存関係定義
├── ecosystem.config.cjs    # PM2設定
├── queue-data.json         # データ永続化ファイル（自動生成）
├── logs/                   # ログディレクトリ（自動生成）
├── public/
│   ├── index.html         # 顧客向け受付画面
│   └── admin.html         # 管理画面
└── README.md              # このファイル
```

---

## 技術スタック

- **バックエンド**: Node.js + Express
- **リアルタイム通信**: Socket.IO
- **メール送信**: Nodemailer (Gmail SMTP)
- **プロセス管理**: PM2
- **データ永続化**: JSON File Storage

---

## セットアップ手順

### 1. 依存関係のインストール
```bash
cd /home/user/webapp
npm install
```

### 2. 環境変数の設定（オプション）
メール機能を使う場合は、環境変数を設定してください：
```bash
export SHOP_EMAIL="your-shop@example.com"
export GMAIL_USER="your-email@gmail.com"
export GMAIL_APP_PASS="your-app-password"
```

または`.env`ファイルを作成してください。

### 3. サーバー起動

#### 開発モード（Nodemon）
```bash
npm run dev
```

#### 本番モード（PM2）
```bash
# ポート3000をクリーンアップ
fuser -k 3000/tcp 2>/dev/null || true

# PM2で起動
pm2 start ecosystem.config.cjs

# ログ確認
pm2 logs matunoki-queue --nostream

# 状態確認
pm2 list

# 停止
pm2 stop matunoki-queue

# 削除
pm2 delete matunoki-queue
```

---

## アクセスURL

**開発環境（ローカル）:**
- 一般受付: http://localhost:3000
- 店舗受付: http://localhost:3000?type=shop
- 管理画面: http://localhost:3000/admin

**サンドボックス環境（現在稼働中）:**
- 一般受付: https://3000-iqvl5rt40arofj936f0b5-cc2fbc16.sandbox.novita.ai
- 店舗受付: https://3000-iqvl5rt40arofj936f0b5-cc2fbc16.sandbox.novita.ai?type=shop
- 管理画面: https://3000-iqvl5rt40arofj936f0b5-cc2fbc16.sandbox.novita.ai/admin

---

## データモデル

### キューアイテム (Guest)
```javascript
{
  displayId: "W-1",           // 表示用ID（W=Web, S=Shop）
  type: "web",                // 受付タイプ（web | shop）
  adults: 2,                  // 大人の人数
  children: 0,                // 子供の人数
  infants: 0,                 // 幼児の人数
  pref: "どこでも",            // 座席希望
  status: "waiting",          // ステータス
  time: "14:30:25",           // 受付時刻（表示用）
  fullDateTime: "2024/02/13 14:30:25", // 完全日時
  timestamp: 1707811825000    // タイムスタンプ（待ち時間計算用）
}
```

### 統計データ (Stats)
```javascript
{
  totalToday: 0,              // 本日受付総数
  completedToday: 0,          // 本日案内完了数
  averageWaitTime: 0          // 平均待ち時間（分）
}
```

---

## ストレージとデータ管理

### データ永続化
- **ファイル**: `queue-data.json`
- **自動保存**: キュー変更時に自動保存
- **自動復元**: サーバー起動時に自動読み込み
- **内容**: キューデータ、統計、受付状態

### バックアップ推奨
定期的に`queue-data.json`のバックアップを取ることを推奨します。

---

## 使い方ガイド

### 顧客向け
1. http://localhost:3000 にアクセス
2. 人数を入力（大人・子供・幼児）
3. 座席希望を選択
4. 「受付確定」ボタンをクリック
5. 表示された受付番号をスクリーンショットで保存
6. 待ち状況を右側のグリッドで確認

### 店舗スタッフ向け
1. http://localhost:3000/admin にアクセス
2. ダッシュボードで待ち状況と統計を確認
3. 顧客を案内したら「案内完了」ボタンをクリック
4. 混雑時は「受付停止」で一時的に新規受付を停止可能
5. 統計をリセットする場合は「統計リセット」をクリック

---

## デプロイ状況

- **プラットフォーム**: サンドボックス環境（Novita AI）
- **ステータス**: ✅ 稼働中
- **公開URL**: https://3000-iqvl5rt40arofj936f0b5-cc2fbc16.sandbox.novita.ai
- **最終更新日**: 2024-02-13

---

## ライセンス

ISC

---

## サポートとお問い合わせ

このシステムに関するご質問やサポートが必要な場合は、開発者にお問い合わせください。
