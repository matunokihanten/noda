# 松乃木飯店 順番待ち受付システム（最終完全版）

## 🎉 すべての機能が実装完了しました！

**松乃木飯店**の店舗向けリアルタイム順番待ち管理システムです。WebSocketを使用してリアルタイムに受付状況を同期し、店舗スタッフと来店客の双方にスムーズな待ち行列体験を提供します。

### 主な機能
- ✅ リアルタイム順番待ち受付（Web・店舗）
- 📊 管理画面での待ち状況管理と統計表示
- 📧 Web予約時の自動メール通知
- 💾 データ永続化（サーバー再起動時も復元）
- ⏸️ 受付の一時停止・自動再開
- 🏪 **店舗用タブレット画面**
- 📱 **到着通知機能**
- 📢 **呼び出し機能（長い音と通知）**
- 🔊 **音声読み上げ機能（ON/OFF切替可能）**
- 🔁 **再呼び出しボタン**
- ⚠️ **不在ボタン（10分後自動キャンセル）**
- 🔄 **起動時日付チェック式自動リセット**
- 💾 **localStorage保存（番号消滅防止）**
- 📝 **名前入力（任意）**
- 🪑 **座席ボタン選択**
- ✅ **確認ダイアログ**
- 📱 レスポンシブデザイン対応

---

## 🆕 最終実装された全機能

### 1. サーバー側（app.js）
- ✅ **起動時日付チェック式リセット**
  - 前回の起動日と今日の日付が違っていたらリセット
  - 電源が切れていても次回起動時に自動リセット
  - 1時間ごとに日付をチェックして自動リセット
- ✅ 名前フィールド対応（任意入力）
- ✅ 全既存機能を完全保持

### 2. ネット受付画面（index.html）
- ✅ **名前入力フィールド（任意）**
- ✅ **座席ボタン選択**（どこでも/カウンター/テーブル/お座敷）
- ✅ **localStorage保存**
  - 自分の受付番号を自動保存
  - ブラウザを閉じても番号を保持
  - 日付が変わるとリセット
  - 自分の番号は太枠で強調表示
- ✅ **長い呼び出し音**（連続5回、各1秒）
- ✅ **20秒間の呼び出し通知表示**
- ✅ **バイブレーション**（9回）

### 3. 店舗受付画面（shop.html）
- ✅ **左右分割レイアウト**
  - 左側：受付入力（固定幅・スクロール防止）
  - 右側：待ち状況表示
- ✅ **コンパクトなボタンサイズ**（スクロール不要）
- ✅ **名前入力フィールド（任意）**
- ✅ **座席ボタン選択**
- ✅ **確認ダイアログ**
  - 大人0名では受付不可
  - 受付内容を確認してから登録
- ✅ **3秒後自動で次の受付画面へ**

### 4. 管理画面（admin.html）
- ✅ **音声読み上げ機能**
  - チェックボックスでON/OFF切替
  - 設定はlocalStorageに保存
  - 「W-1番、田中様、大人2名、お呼び出しです」と読み上げ
- ✅ **再呼び出しボタン**
  - 呼び出し済みの客に再度通知
  - 音声も再生
- ✅ **呼び出し後の行色変更**
  - 呼び出し中の行は黄色背景で太字
  - 視認性アップ
- ✅ **名前表示**
- ✅ **全既存機能を完全保持**

---

## アクセスURL

**サンドボックス環境（現在稼働中）:**
- ネット受付: https://3000-iqvl5rt40arofj936f0b5-cc2fbc16.sandbox.novita.ai
- 店舗受付: https://3000-iqvl5rt40arofj936f0b5-cc2fbc16.sandbox.novita.ai/shop
- 管理画面: https://3000-iqvl5rt40arofj936f0b5-cc2fbc16.sandbox.novita.ai/admin

---

## セットアップ手順

```bash
cd /home/user/webapp
npm install
fuser -k 3000/tcp 2>/dev/null || true
pm2 start ecosystem.config.cjs
pm2 logs matunoki-queue --nostream
```

---

## 使い方ガイド

### ネット受付（お客様向け）
1. スマホでネット受付URLにアクセス
2. お名前を入力（任意・省略可）
3. 人数を入力
4. 座席をボタンで選択
5. 「受付確定」をクリック
6. 番号を撮影（自動でlocalStorageに保存）
7. 呼び出し時は音が5回鳴り、画面に大きく表示
8. 店舗到着時は店舗タブレットで番号をタップ

### 店舗受付（店舗スタッフ向け）
1. タブレットで店舗受付URLにアクセス
2. 左側で受付入力
   - 名前入力（任意）
   - 人数入力
   - 座席ボタン選択
   - 確認ダイアログ → 確定
3. 右側でネット予約の到着確認
   - 番号をタップして到着マーク
4. 3秒後自動で次の受付へ

### 管理画面（店舗スタッフ向け）
1. 管理画面URLにアクセス
2. **音声読み上げON/OFF**をチェック
3. 呼び出し
   - 「📢 呼び出し」ボタン → 音声読み上げ
   - 「🔁 再呼び出し」ボタン → 戻ってこない客に再通知
4. 不在管理
   - 「不在」ボタン → 10分後自動削除
   - 「不在解除」で復活
5. 案内完了

---

## 自動リセット機能

**起動時日付チェック方式:**
- サーバー起動時に前回の日付と比較
- 日付が違っていれば自動リセット
- 電源が切れていても確実にリセット
- 1時間ごとに日付をチェック（実行中の場合）

**リセット内容:**
- 全待ち客データをクリア
- 受付番号を1番から再スタート
- 統計情報リセット

---

## プロジェクト構造

```
webapp/
├── app.js                  # サーバー（起動時日付チェック式リセット）
├── package.json            # 依存関係
├── ecosystem.config.cjs    # PM2設定
├── queue-data.json         # データ保存（lastResetDate含む）
├── logs/                   # ログ
├── public/
│   ├── index.html         # ネット受付（localStorage、名前、座席ボタン、長い音）
│   ├── shop.html          # 店舗受付（左右分割、コンパクト、確認ダイアログ）
│   └── admin.html         # 管理画面（音声読み上げ、再呼び出し、行色変更）
└── README.md              # このファイル
```

---

## 技術スタック

- **Node.js + Express** - サーバー
- **Socket.IO** - リアルタイム通信
- **Web Audio API** - 音響生成
- **Web Speech API** - 音声読み上げ
- **Vibration API** - バイブレーション
- **localStorage** - クライアント側データ保存
- **PM2** - プロセス管理

---

## 完成度100%達成！

すべての要件が実装されました：

1. ✅ 呼び出し音を長く（連続5回、各1秒）
2. ✅ 店舗画面のボタンサイズ調整とレイアウト改善
3. ✅ 待ち状況を右側に表示
4. ✅ 座席をボタン選択に変更
5. ✅ 起動時日付チェック式自動リセット
6. ✅ localStorageで番号保存
7. ✅ 管理画面の呼び出し後行色変更
8. ✅ 店舗画面の入力ミス防止（確認ダイアログ）
9. ✅ 名前入力（任意）
10. ✅ 音声読み上げ機能（ON/OFF切替）
11. ✅ 再呼び出し機能
12. ✅ 店舗画面の自動リセット（3秒後）

---

## ライセンス

ISC

---

## 最終更新日

2024-02-15


---

## 🆕 新機能（完全版）

### 1. 画面の分離
システムは3つの画面に分離されています：

| 画面 | URL | 用途 |
|------|-----|------|
| ネット受付 | `/` | お客様がスマホで順番待ち登録 |
| 店舗受付 | `/shop` | 店舗スタッフがタブレットで直接受付 |
| 管理画面 | `/admin` | 店舗スタッフが待ち状況を管理 |

### 2. 到着通知機能
- ネット予約のお客様が店舗に到着
- 店舗タブレットで自分の番号をタップ
- 「到着済み」と管理画面・店舗タブレットに緑色で表示
- 到着音が鳴る

### 3. 呼び出し機能
**管理画面から呼び出し：**
- 「📢 呼び出し」ボタンをクリック
- **ネット予約の方**：スマホに大きな通知が表示され、音が3回鳴る
- **店舗受付の方**：店舗タブレットに「呼び出し中」と表示
- 全画面で該当番号がオレンジ色で強調表示

### 4. 不在ボタン
**管理画面から不在マーク：**
- 「不在」ボタンをクリック
- 該当のお客様が赤色で表示（不在状態）
- **10分後に自動的にキャンセル**
- 「不在解除」ボタンでキャンセルを中止可能

### 5. 日次自動リセット
- **毎日0時に自動実行**
- 全ての待ち状況をクリア
- 統計情報をリセット
- 受付番号を1番から再スタート
- 全クライアントに通知

---

## 現在完成している機能

### ✅ ネット受付画面 (`/`)
- 人数入力（大人・子供・幼児）
- 座席希望の選択
- リアルタイム待ち状況表示
- 受付番号の発行と表示
- **呼び出し通知受信（音・バイブ・画面表示）**
- 受付停止時の通知表示

### ✅ 店舗受付画面 (`/shop`)
- 店舗での直接受付機能
- **ネット予約の到着確認**（タップで到着マーク）
- 店舗受付の待ち状況表示
- 到着済み・呼び出し中・不在の状態表示
- 受付停止時の通知表示

### ✅ 管理画面 (`/admin`)
- リアルタイム時計表示
- 統計情報ダッシュボード
  - 現在待ち組数
  - 本日受付総数
  - 本日案内完了数
  - 平均待ち時間（分）
- 受付コントロール
  - 即時停止
  - 30分/60分停止（自動再開）
  - 手動再開
  - 統計リセット
- 待ち状況一覧
  - 受付番号
  - 受付時刻
  - 待ち時間（リアルタイム更新）
  - 人数詳細
  - 座席希望
  - タイプ表示（店舗/Web）
  - 状態バッジ（到着済み/呼び出し中/不在）
  - **📢 呼び出しボタン**
  - **⚠️ 不在ボタン**
  - 不在解除ボタン
  - 案内完了ボタン

### ✅ バックエンド機能
- Socket.IOによるリアルタイム通信
- JSONファイルによるデータ永続化
- Gmail SMTPによるメール通知
- **不在タイマー管理（10分後自動キャンセル）**
- **日次自動リセット機能**
- エラーハンドリングとログ出力
- 環境変数対応

---

## 機能別URIとパラメータ

### エンドポイント一覧

| URI | 説明 | パラメータ |
|-----|------|-----------|
| `/` | ネット予約受付画面 | なし |
| `/shop` | 店舗タブレット画面 | なし |
| `/admin` | 管理画面 | なし |
| `/api/stats` | 統計情報API (GET) | なし |

### Socket.IOイベント

**クライアント → サーバー**
- `register` - 新規受付登録
- `markArrived` - 到着通知
- `callGuest` - 呼び出し
- `markAbsent` - 不在マーク
- `cancelAbsent` - 不在解除
- `updateStatus` - ステータス更新（案内完了）
- `setAcceptance` - 受付状態変更
- `resetStats` - 統計リセット

**サーバー → クライアント**
- `init` - 初期データ送信
- `update` - キューデータ更新
- `statusChange` - 受付状態変更通知
- `registered` - 登録完了通知
- `guestArrived` - 到着通知
- `guestCalled` - 呼び出し通知
- `guestAutoCancelled` - 自動キャンセル通知
- `dailyReset` - 日次リセット通知
- `error` - エラー通知

---

## まだ実装されていない機能

以下の機能は基本システムには含まれていませんが、拡張可能です：

- ❌ ユーザー認証・ログイン機能（意図的に実装なし）
- ❌ SMS通知機能
- ❌ QRコード発行機能
- ❌ 多店舗対応
- ❌ 予約機能（現在は順番待ちのみ）
- ❌ データベース連携（現在はJSON保存）
- ❌ 分析・レポート機能

---

## 推奨される次の開発ステップ

1. **SMS通知の追加**
   - Twilio等のSMS APIを統合
   - 順番が近づいたら自動通知

2. **データベース移行**
   - SQLiteまたはPostgreSQLへの移行
   - より堅牢なデータ管理

3. **多言語対応**
   - 英語・中国語対応
   - 国際観光客向け

4. **QRコード機能**
   - 受付番号のQRコード生成
   - 読み取りによる本人確認

5. **分析ダッシュボード**
   - 週次・月次レポート
   - ピーク時間帯分析

---

## プロジェクト構造

```
webapp/
├── app.js                  # メインサーバーファイル（拡張版）
├── package.json            # 依存関係定義
├── ecosystem.config.cjs    # PM2設定
├── queue-data.json         # データ永続化ファイル（自動生成）
├── logs/                   # ログディレクトリ（自動生成）
├── public/
│   ├── index.html         # ネット受付画面（呼び出し音対応）
│   ├── shop.html          # 店舗タブレット画面（NEW）
│   └── admin.html         # 管理画面（呼び出し・不在機能追加）
└── README.md              # このファイル
```

---

## 技術スタック

- **バックエンド**: Node.js + Express
- **リアルタイム通信**: Socket.IO
- **メール送信**: Nodemailer (Gmail SMTP)
- **プロセス管理**: PM2
- **データ永続化**: JSON File Storage
- **音響生成**: Web Audio API

---

## セットアップ手順

### 1. 依存関係のインストール
```bash
cd /home/user/webapp
npm install
```

### 2. 環境変数の設定（オプション）
```bash
export SHOP_EMAIL="your-shop@example.com"
export GMAIL_USER="your-email@gmail.com"
export GMAIL_APP_PASS="your-app-password"
```

### 3. サーバー起動

```bash
# ポート3000をクリーンアップ
fuser -k 3000/tcp 2>/dev/null || true

# PM2で起動
pm2 start ecosystem.config.cjs

# ログ確認
pm2 logs matunoki-queue --nostream

# 状態確認
pm2 list
```

---

## アクセスURL

**開発環境（ローカル）:**
- ネット受付: http://localhost:3000
- 店舗受付: http://localhost:3000/shop
- 管理画面: http://localhost:3000/admin

**サンドボックス環境（現在稼働中）:**
- ネット受付: https://3000-iqvl5rt40arofj936f0b5-cc2fbc16.sandbox.novita.ai
- 店舗受付: https://3000-iqvl5rt40arofj936f0b5-cc2fbc16.sandbox.novita.ai/shop
- 管理画面: https://3000-iqvl5rt40arofj936f0b5-cc2fbc16.sandbox.novita.ai/admin

---

## データモデル

### キューアイテム (Guest)
```javascript
{
  displayId: "W-1",           // 表示用ID（W=Web, S=Shop）
  type: "web",                // 受付タイプ（web | shop）
  adults: 2,                  // 大人の人数
  children: 0,                // 子供の人数
  infants: 0,                 // 幼児の人数
  pref: "どこでも",            // 座席希望
  status: "waiting",          // ステータス
  arrived: false,             // 到着フラグ（NEW）
  called: false,              // 呼び出しフラグ（NEW）
  absent: false,              // 不在フラグ（NEW）
  time: "14:30:25",           // 受付時刻（表示用）
  fullDateTime: "2024/02/13 14:30:25", // 完全日時
  timestamp: 1707811825000,   // タイムスタンプ（待ち時間計算用）
  arrivedTime: "14:35:10",    // 到着時刻（オプション）
  calledTime: "14:40:00",     // 呼び出し時刻（オプション）
  absentTime: "14:42:00"      // 不在マーク時刻（オプション）
}
```

---

## 使い方ガイド

### ネット受付（お客様向け）
1. スマホで http://localhost:3000 にアクセス
2. 人数を入力（大人・子供・幼児）
3. 座席希望を選択
4. 「受付確定」ボタンをクリック
5. 表示された受付番号をスクリーンショットで保存
6. 店舗到着時は、店舗タブレットで自分の番号をタップ
7. 呼び出しがあると、スマホに通知と音が届く

### 店舗受付（店舗スタッフ向け）
1. タブレットで http://localhost:3000/shop にアクセス
2. **ネット予約のお客様到着時**：
   - 「ネット予約の方 - 到着確認」セクションで番号をタップ
   - 到着済みとしてマーク
3. **店舗で直接受付**：
   - 上部フォームで人数と座席希望を入力
   - 「受付確定」をクリック

### 管理画面（店舗スタッフ向け）
1. http://localhost:3000/admin にアクセス
2. ダッシュボードで待ち状況と統計を確認
3. **お客様を呼び出す**：「📢 呼び出し」ボタンをクリック
4. **不在の場合**：「不在」ボタンをクリック（10分後自動削除）
5. **不在を解除**：「不在解除」ボタンをクリック
6. **案内完了**：「✓ 案内完了」ボタンをクリック
7. 混雑時は「受付停止」で一時的に新規受付を停止可能

---

## 自動リセット機能

**毎日0時に自動実行される内容：**
- 全ての待ち客データをクリア
- 受付番号を1番からリセット
- 統計情報（本日受付総数、案内完了数、平均待ち時間）をリセット
- 全クライアントに通知メッセージを表示

※ データは自動的にバックアップされ、サーバー再起動時も復元されます。

---

## デプロイ状況

- **プラットフォーム**: サンドボックス環境（Novita AI）
- **ステータス**: ✅ 稼働中
- **最終更新日**: 2024-02-13

---

## ライセンス

ISC

---

## サポートとお問い合わせ

このシステムに関するご質問やサポートが必要な場合は、開発者にお問い合わせください。
