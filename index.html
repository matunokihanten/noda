<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¾ä¹ƒæœ¨é£¯åº— é †ç•ªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« [cite: 238-290, 365-438] */
        body { font-family: sans-serif; background: #fdfaf5; margin: 0; padding: 0; }
        .view { display: none; padding: 20px; }
        .active { display: block; }
        header { background: #8b0000; color: white; padding: 15px; text-align: center; }
        .btn { padding: 15px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-reg { background: #8b0000; color: white; }
        .btn-print { background: #27ae60; color: white; text-decoration: none; display: inline-block; text-align: center; }
        .card { background: white; border: 2px solid #d4b483; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .queue-item { border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .called { background: #fff3cd; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <header><h1 id="mainTitle">ğŸ® æ¾ä¹ƒæœ¨é£¯åº—</h1></header>

    <div id="userView" class="view active">
        <div id="formArea" class="card">
            <h3>æ–°è¦å—ä»˜</h3>
            <input type="text" id="nameInput" placeholder="ãŠåå‰ï¼ˆä»»æ„ï¼‰" style="width:90%; padding:10px; margin-bottom:10px;">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn" onclick="adjustNum(-1)">ãƒ¼</button>
                <div id="adultNum" style="font-size:2em; width:50px; text-align:center;">2</div>
                <button class="btn" onclick="adjustNum(1)">ï¼‹</button>
            </div>
            <button class="btn btn-reg" onclick="register()">å—ä»˜ç¢ºå®š</button>
        </div>

        <div id="ticketArea" class="card" style="display:none; text-align:center;">
            <h2 style="color:#27ae60;">âœ… å—ä»˜å®Œäº†</h2>
            <div id="displayId" style="font-size:5em; font-weight:bold; color:#8b0000;">--</div>
            <div id="waitMsg" style="color:#e67e22; font-weight:bold; margin:15px 0;"></div>
            
            <a id="printBtn" href="#" class="btn btn-print">ğŸ–¨ï¸ ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ç™ºè¡Œ (mC-Print3)</a>
            
            <button class="btn" onclick="location.reload()" style="background:#666; color:white;">é–‰ã˜ã‚‹</button>
        </div>

        <div class="card">
            <h3>ç¾åœ¨ã®å¾…ã¡çŠ¶æ³</h3>
            <div id="queueList"></div>
        </div>
    </div>

    <div id="adminView" class="view">
        <div class="card">
            <h3>ğŸ“Š æœ¬æ—¥ã®çµ±è¨ˆ</h3>
            <div id="statPanel">å¾…ã¡ï¼š0çµ„ / å®Œäº†ï¼š0çµ„</div>
        </div>
        <div class="card">
            <h3>ğŸ“‹ å¾…ã¡ãƒªã‚¹ãƒˆ</h3>
            <div id="adminQueueList"></div>
        </div>
    </div>

    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'user'; // ?mode=admin ã§ç®¡ç†ç”»é¢ã¸ [cite: 63]
        let adults = 2;

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ [cite: 16]
        if (mode === 'admin') {
            document.getElementById('userView').classList.remove('active');
            document.getElementById('adminView').classList.add('active');
            document.getElementById('mainTitle').innerText = "ğŸ® ç®¡ç†ç”»é¢";
        }

        function adjustNum(step) {
            adults = Math.max(1, adults + step);
            document.getElementById('adultNum').innerText = adults;
        }

        function register() {
            const name = document.getElementById('nameInput').value;
            const type = urlParams.get('mode') === 'shop' ? 'shop' : 'web'; // ?mode=shop ã§åº—èˆ—å—ä»˜ [cite: 17, 62]
            socket.emit('register', { type, adults, name, pref: 'ã©ã“ã§ã‚‚' });
        }

        socket.on('registered', g => {
            document.getElementById('formArea').style.display = 'none';
            document.getElementById('ticketArea').style.display = 'block';
            document.getElementById('displayId').innerText = g.displayId;

            // ã€mC-Print3 è§£æ±ºç­–ã€‘URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ 
            const myUrl = window.location.href;
            const text = `æ¾ä¹ƒæœ¨é£¯åº—%0A----------------%0Aç•ªå·ï¼š${g.displayId}%0AãŠåå‰ï¼š${g.name || 'ãªã—'}%0Aäººæ•°ï¼š${g.adults}å%0A----------------`;
            document.getElementById('printBtn').href = `starpassprnt://v1/print/nopreview?text=${text}&back=${encodeURIComponent(myUrl)}`;
        });

        socket.on('update', d => {
            const list = document.getElementById('queueList');
            const adminList = document.getElementById('adminQueueList');
            list.innerHTML = ""; adminList.innerHTML = "";

            d.queue.forEach((g, index) => {
                // å¾…ã¡æ™‚é–“è¨ˆç®—ï¼ˆ1.2å€ã®ãƒãƒƒãƒ•ã‚¡ï¼‰[cite: 97, 320]
                const wait = Math.max(10, Math.ceil((index * (d.stats.averageWaitTime || 10) * 1.2) / 5) * 5);
                const itemHtml = `<div class="queue-item ${g.called ? 'called' : ''}">
                    <span>${g.displayId} (${g.adults}å)</span>
                    <span>${g.called ? 'ğŸ“¢ å‘¼å‡ºä¸­' : 'å¾…ã¡'}</span>
                </div>`;
                list.innerHTML += itemHtml;

                // ç®¡ç†ç”»é¢ç”¨ãƒªã‚¹ãƒˆ [cite: 299-302]
                if (mode === 'admin') {
                    adminList.innerHTML += `<div class="queue-item">
                        <span>${g.displayId} ${g.name || ''}</span>
                        <div>
                            <button onclick="call('${g.displayId}')">ğŸ“¢ å‘¼å‡º</button>
                            <button onclick="done('${g.displayId}')">âœ“ å®Œäº†</button>
                        </div>
                    </div>`;
                }
            });
            document.getElementById('statPanel').innerText = `å¾…ã¡ï¼š${d.queue.length}çµ„ / å®Œäº†ï¼š${d.stats.completedToday}çµ„ / å¹³å‡ï¼š${d.stats.averageWaitTime}åˆ†`;
        });

        function call(id) { socket.emit('callGuest', { displayId: id }); }
        function done(id) { if(confirm('æ¡ˆå†…å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ')) socket.emit('updateStatus', { displayId: id, status: 'completed' }); }

        // å‘¼ã³å‡ºã—éŸ³ [cite: 354, 477]
        socket.on('guestCalled', data => {
            if (mode !== 'admin') {
                const audio = new AudioContext();
                const osc = audio.createOscillator();
                osc.connect(audio.destination);
                osc.start(); osc.stop(audio.currentTime + 0.5);
                alert("ãŠå‘¼ã³å‡ºã—ã§ã™ï¼åº—å†…ã¸ãŠè¶Šã—ãã ã•ã„ã€‚");
            }
        });
    </script>
</body>
</html>